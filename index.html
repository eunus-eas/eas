<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Eunus Accounts System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Hind Siliguri', system-ui, -apple-system, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 16px;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.05"><path d="M20 20 L80 20 L80 80 L20 80 Z" fill="none" stroke="white" stroke-width="2"/><circle cx="50" cy="50" r="15" fill="none" stroke="white" stroke-width="2"/></svg>') repeat;
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: relative;
            z-index: 1;
        }
        
        .app-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 20px 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-bottom: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .app-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            animation: shimmer 10s infinite linear;
            pointer-events: none;
        }
        
        @keyframes shimmer {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            position: relative;
        }
        
        .company-name-left {
            font-size: 1.2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .company-name-right {
            text-align: right;
        }
        
        .mini-mart {
            font-size: 1rem;
            font-weight: 600;
            color: #2d3748;
            line-height: 1.3;
        }
        
        .owner-name {
            font-size: 0.9rem;
            color: #718096;
            font-weight: 500;
            margin-top: 2px;
        }
        
        .header-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, #667eea, #764ba2, #667eea, transparent);
            width: 100%;
            margin: 12px 0 8px 0;
        }
        
        .system-title {
            text-align: center;
            font-size: 0.9rem;
            color: #4a5568;
            font-weight: 500;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        .main-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            flex-wrap: wrap;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 12px;
            border-radius: 40px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            z-index: 100;
        }
        
        .main-tab {
            flex: 1;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 14px 8px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 0.9rem;
            color: #4a5568;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.5);
            min-width: auto;
            backdrop-filter: blur(5px);
        }
        
        .main-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
            background: white;
        }
        
        .main-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
            border-color: transparent;
        }
        
        .main-tab.inc-tab.active {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        
        .main-tab.stock-tab.active {
            background: linear-gradient(135deg, #e67e22, #d35400);
        }
        
        .main-tab.expense-tab.active {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .main-tab.profit-tab.active {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }
        
        .main-tab.note-tab.active {
            background: linear-gradient(135deg, #f1c40f, #f39c12);
        }
        
        .header-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 30px;
            padding: 24px 20px;
            color: #fff;
            box-shadow: 0 20px 30px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
        }
        
        .header-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .balance-show {
            text-align: center;
            position: relative;
            z-index: 1;
        }
        
        .balance-label {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 500;
        }
        
        .balance-amount {
            font-size: 2.8rem;
            font-weight: 800;
            line-height: 1.2;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .cash-header {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            border-radius: 30px;
            padding: 24px 20px;
            color: #fff;
            box-shadow: 0 20px 30px rgba(46, 204, 113, 0.3);
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .cash-header .cash-total {
            font-size: 2.8rem;
            font-weight: 800;
            line-height: 1.2;
            text-align: center;
        }
        
        .cash-header .cash-label {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 8px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: transform 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .tab-nav {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .tab {
            flex: 1;
            background: #f7fafc;
            border: none;
            padding: 16px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1rem;
            color: #4a5568;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: 2px solid transparent;
        }
        
        .tab.inc.active {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: #fff;
            box-shadow: 0 10px 20px rgba(46, 204, 113, 0.3);
        }
        
        .tab.exp.active {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: #fff;
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
        }
        
        .customer-section {
            position: relative;
            z-index: 100;
            margin-bottom: 15px;
        }
        
        .search-wrapper {
            display: flex;
            align-items: center;
            background: #f7fafc;
            border-radius: 25px;
            padding: 5px 5px 5px 15px;
            border: 2px solid #edf2f7;
            transition: all 0.3s;
        }
        
        .search-wrapper:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .search-icon {
            padding: 0 8px;
            color: #a0aec0;
            font-size: 1.2rem;
        }
        
        .search-wrapper input {
            flex: 1;
            padding: 16px 8px;
            border: none;
            background: transparent;
            font-size: 1rem;
            outline: none;
            color: #2d3748;
        }
        
        .search-wrapper input::placeholder {
            color: #a0aec0;
        }
        
        .customer-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border-radius: 25px;
            margin-top: 8px;
            max-height: 250px;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            z-index: 9999;
            display: none;
            border: 1px solid #e2e8f0;
        }
        
        .customer-list.show {
            display: block;
        }
        
        .cust-item {
            padding: 16px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
        }
        
        .cust-item:hover {
            background: #f8fafd;
            padding-left: 24px;
        }
        
        .cust-item.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
        }
        
        .cust-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 600;
            font-size: 1.2rem;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }
        
        .cust-item.selected .cust-avatar {
            background: #fff;
            color: #667eea;
        }
        
        .btn-new {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: #fff;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            margin-top: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 1rem;
            box-shadow: 0 10px 20px rgba(46, 204, 113, 0.2);
            transition: all 0.3s;
        }
        
        .btn-new:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(46, 204, 113, 0.3);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
            font-size: 0.95rem;
        }
        
        .input-wrapper {
            display: flex;
            align-items: center;
            background: #f7fafc;
            border-radius: 25px;
            border: 2px solid #edf2f7;
            padding: 0 5px 0 15px;
            transition: all 0.3s;
        }
        
        .input-wrapper:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .input-icon {
            padding: 0 8px;
            color: #a0aec0;
            font-size: 1.2rem;
        }
        
        .input-wrapper input,
        .input-wrapper textarea,
        .input-wrapper select {
            flex: 1;
            padding: 16px 8px;
            border: none;
            background: transparent;
            font-size: 1rem;
            outline: none;
            color: #2d3748;
        }
        
        .input-wrapper select {
            padding: 16px 8px;
            cursor: pointer;
        }
        
        .input-wrapper textarea {
            min-height: 100px;
            padding: 16px 8px;
            resize: vertical;
        }
        
        .btn-save {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            border: none;
            border-radius: 25px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.2);
            transition: all 0.3s;
        }
        
        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.3);
        }
        
        .filter-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 20px;
            margin: 10px 0;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .filter-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }
        
        .date-filter {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .date-input {
            flex: 1;
        }
        
        .date-input label {
            font-size: 0.8rem;
            color: #718096;
            margin-bottom: 5px;
            display: block;
            font-weight: 500;
        }
        
        .date-input input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            font-size: 0.95rem;
            transition: all 0.3s;
        }
        
        .date-input input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .filter-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .filter-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
        }
        
        .apply-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .reset-btn {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .balance-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .bal-tag {
            flex: 1;
            padding: 12px 8px;
            border: 2px solid #e2e8f0;
            border-radius: 30px;
            background: #fff;
            cursor: pointer;
            font-size: 0.9rem;
            text-align: center;
            font-weight: 500;
            transition: all 0.3s;
            min-width: 70px;
        }
        
        .bal-tag.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            border-color: transparent;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .bal-tag.positive.active {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        
        .bal-tag.negative.active {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .export-group {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }
        
        .export-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.95rem;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .excel-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: #fff;
        }
        
        .txt-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: #fff;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .summary-item {
            background: linear-gradient(145deg, #ffffff, #f8fafd);
            padding: 18px 12px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }
        
        .summary-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .summary-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        
        .summary-value {
            font-weight: 800;
            font-size: 1.4rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .customer-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            padding: 18px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }
        
        .customer-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }
        
        .customer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .customer-name {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.3rem;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .name h4 {
            font-size: 1.1rem;
            color: #2d3748;
            margin-bottom: 4px;
        }
        
        .name p {
            font-size: 0.8rem;
            color: #718096;
        }
        
        .balance-badge {
            font-size: 1.2rem;
            font-weight: 700;
            padding: 8px 12px;
            border-radius: 30px;
        }
        
        .positive {
            color: #2ecc71;
        }
        
        .negative {
            color: #e74c3c;
        }
        
        .customer-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 2px dashed #e2e8f0;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #718096;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        
        .stat-value {
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .cash-input-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .cash-input-item {
            text-align: center;
        }
        
        .cash-input-item label {
            font-size: 0.8rem;
            color: #64748b;
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .cash-input-item input {
            width: 100%;
            padding: 14px 8px;
            border: 2px solid #e2e8f0;
            border-radius: 18px;
            text-align: center;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .cash-input-item input:focus {
            border-color: #2ecc71;
            outline: none;
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.1);
        }
        
        .past-cash-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .past-cash-item {
            background: linear-gradient(145deg, #ffffff, #f8fafd);
            border-radius: 16px;
            padding: 10px 5px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }
        
        .past-cash-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .past-cash-day {
            font-size: 0.7rem;
            color: #64748b;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .past-cash-amount {
            font-weight: 700;
            font-size: 0.9rem;
            color: #2d3748;
        }
        
        .average-cash-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 15px;
        }
        
        .average-card {
            background: linear-gradient(145deg, #ffffff, #f8fafd);
            border-radius: 24px;
            padding: 20px 12px;
            text-align: center;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .average-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #2ecc71, #27ae60);
        }
        
        .average-card:last-child::before {
            background: linear-gradient(90deg, #3498db, #2980b9);
        }
        
        .average-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 30px -10px rgba(46, 204, 113, 0.2);
        }
        
        .average-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .average-value {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
            margin-bottom: 5px;
        }
        
        .average-card:last-child .average-value {
            background: linear-gradient(135deg, #3498db, #2980b9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .average-days {
            font-size: 0.8rem;
            color: #94a3b8;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .average-days::before {
            content: 'ðŸ“…';
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        .stock-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 12px;
        }
        
        .total-stock {
            flex: 1;
            background: linear-gradient(135deg, #e67e22, #d35400);
            color: #fff;
            padding: 18px 16px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 15px 25px -8px rgba(230, 126, 34, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .total-stock::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            animation: shimmer 6s infinite linear;
        }
        
        .total-stock:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 30px -10px rgba(230, 126, 34, 0.4);
        }
        
        .total-stock span {
            font-size: 1.4rem;
            font-weight: 800;
            margin-left: 5px;
        }
        
        .purchase-average-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 15px;
        }
        
        .purchase-average-card {
            background: linear-gradient(145deg, #ffffff, #f8fafd);
            border-radius: 24px;
            padding: 18px 12px;
            text-align: center;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .purchase-average-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #e67e22, #d35400);
        }
        
        .purchase-average-card:last-child::before {
            background: linear-gradient(90deg, #95a5a6, #7f8c8d);
        }
        
        .purchase-average-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 30px -10px rgba(230, 126, 34, 0.15);
        }
        
        .purchase-average-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .purchase-average-value {
            font-size: 1.6rem;
            font-weight: 800;
            background: linear-gradient(135deg, #e67e22, #d35400);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
            margin-bottom: 5px;
        }
        
        .purchase-average-card:last-child .purchase-average-value {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .purchase-average-days {
            font-size: 0.8rem;
            color: #94a3b8;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .purchase-average-days::before {
            content: 'ðŸ›’';
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        .expense-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .expense-summary-card {
            background: linear-gradient(145deg, #ffffff, #fef2f2);
            border-radius: 24px;
            padding: 20px 12px;
            text-align: center;
            box-shadow: 0 10px 25px -5px rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .expense-summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }
        
        .expense-summary-card:last-child::before {
            background: linear-gradient(90deg, #95a5a6, #7f8c8d);
        }
        
        .expense-summary-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 30px -10px rgba(231, 76, 60, 0.2);
        }
        
        .expense-summary-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .expense-summary-value {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
            margin-bottom: 5px;
        }
        
        .expense-summary-card:last-child .expense-summary-value {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .expense-summary-days {
            font-size: 0.8rem;
            color: #94a3b8;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .expense-summary-days::before {
            content: 'ðŸ“Š';
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        .transaction-item {
            background: #ffffff;
            border-radius: 25px;
            padding: 18px;
            margin-bottom: 12px;
            border: 1px solid #edf2f7;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .transaction-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }
        
        .trans-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .type-badge {
            padding: 6px 16px;
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .type-inc {
            background: #e8f5e9;
            color: #2ecc71;
        }
        
        .type-exp {
            background: #ffebee;
            color: #e74c3c;
        }
        
        .amount {
            font-size: 1.3rem;
            font-weight: 700;
        }
        
        .amount.positive {
            color: #2ecc71;
        }
        
        .amount.negative {
            color: #e74c3c;
        }
        
        .trans-details {
            margin: 10px 0;
            color: #4a5568;
            line-height: 1.5;
        }
        
        .trans-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #718096;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #e2e8f0;
        }
        
        .trans-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        
        .trans-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .trans-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .stock-item {
            background: #ffffff;
            border-radius: 25px;
            padding: 18px;
            margin-bottom: 12px;
            border: 1px solid #edf2f7;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #e67e22;
        }
        
        .stock-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }
        
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .stock-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: #e67e22;
        }
        
        .stock-qty {
            background: #e67e22;
            color: #fff;
            padding: 5px 15px;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .stock-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 15px 0;
            padding: 15px;
            background: #f8fafd;
            border-radius: 20px;
        }
        
        .stock-detail-item {
            text-align: center;
        }
        
        .stock-detail-label {
            font-size: 0.75rem;
            color: #718096;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .stock-detail-value {
            font-weight: 700;
            font-size: 1.1rem;
            color: #2d3748;
        }
        
        .stock-detail-value.positive {
            color: #2ecc71;
        }
        
        .stock-detail-value.negative {
            color: #e74c3c;
        }
        
        .stock-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .stock-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .stock-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .expense-item {
            background: #ffffff;
            border-radius: 25px;
            padding: 18px;
            margin-bottom: 12px;
            border: 1px solid #edf2f7;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #e74c3c;
        }
        
        .expense-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }
        
        .expense-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .expense-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: #e74c3c;
        }
        
        .expense-amount {
            font-size: 1.2rem;
            font-weight: 700;
            color: #e74c3c;
            background: #ffebee;
            padding: 5px 15px;
            border-radius: 30px;
        }
        
        .expense-desc {
            background: #f8fafd;
            padding: 12px;
            border-radius: 18px;
            margin: 10px 0;
            font-size: 0.95rem;
            color: #4a5568;
        }
        
        .expense-meta {
            font-size: 0.85rem;
            color: #718096;
            margin: 10px 0;
            padding-top: 10px;
            border-top: 1px dashed #e2e8f0;
        }
        
        .expense-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        
        .expense-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .expense-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .note-item {
            background: #ffffff;
            border-radius: 25px;
            padding: 18px;
            margin-bottom: 12px;
            border: 1px solid #edf2f7;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #f1c40f;
        }
        
        .note-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }
        
        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .note-time {
            font-size: 0.8rem;
            color: #718096;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .note-content {
            font-size: 1rem;
            color: #2d3748;
            line-height: 1.6;
            margin: 10px 0;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .note-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .note-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .note-select-btn {
            background: #f1c40f;
            color: #2d3748;
        }
        
        .note-edit-btn {
            background: #f39c12;
            color: #fff;
        }
        
        .note-delete-btn {
            background: #e74c3c;
            color: #fff;
        }
        
        .note-copy-btn {
            background: #3498db;
            color: #fff;
        }
        
        .note-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .selected-notes {
            background: rgba(241, 196, 15, 0.1);
            border-radius: 20px;
            padding: 15px;
            margin-top: 15px;
            border: 2px dashed #f1c40f;
        }
        
        .selected-notes-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #f1c40f;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .selected-note-item {
            background: #fff;
            border-radius: 15px;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid #ffeaa7;
            font-size: 0.9rem;
            color: #2d3748;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .selected-note-content {
            flex: 1;
            margin-right: 10px;
            word-break: break-word;
        }
        
        .selected-note-remove {
            color: #e74c3c;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0 5px;
        }
        
        .floating-notes {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            border-radius: 0 0 30px 30px;
            padding: 12px 16px;
            margin-bottom: 16px;
            box-shadow: 0 10px 30px rgba(241, 196, 15, 0.3);
            color: #fff;
            animation: slideDown 0.3s ease;
            max-height: 200px;
            overflow-y: auto;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .floating-notes-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
            opacity: 0.9;
        }
        
        .floating-note-item {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 8px 12px;
            margin-bottom: 6px;
            font-size: 0.9rem;
            border-left: 3px solid #fff;
            backdrop-filter: blur(5px);
        }
        
        .floating-note-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-right: 8px;
        }
        
        .profit-card {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            border-radius: 30px;
            padding: 24px;
            color: #fff;
            margin-bottom: 15px;
            box-shadow: 0 20px 30px rgba(155, 89, 182, 0.3);
        }
        
        .profit-result {
            text-align: center;
        }
        
        .profit-label {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .profit-amount {
            font-size: 2.8rem;
            font-weight: 800;
            line-height: 1.2;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .calculation-card {
            background: #f8fafd;
            border-radius: 25px;
            padding: 18px;
            margin-bottom: 15px;
            border: 2px solid #edf2f7;
        }
        
        .calculation-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 2px dashed #e2e8f0;
        }
        
        .calculation-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .calculation-label {
            font-weight: 500;
            color: #4a5568;
        }
        
        .calculation-value {
            font-weight: 600;
            color: #2d3748;
        }
        
        .date-filter-result {
            background: #f8fafd;
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .filter-result-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2d3748;
            font-size: 1rem;
        }
        
        .filter-result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .filter-result-label {
            color: #64748b;
        }
        
        .filter-result-value {
            font-weight: 600;
            color: #2d3748;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(8px);
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 40px;
            padding: 28px;
            width: 95%;
            max-width: 450px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #edf2f7;
        }
        
        .modal-header h3 {
            font-size: 1.3rem;
            color: #2d3748;
            font-weight: 700;
        }
        
        .close-btn {
            background: #f1f5f9;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .close-btn:hover {
            background: #e2e8f0;
            transform: rotate(90deg);
        }
        
        .info-msg {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
            font-size: 1.1rem;
        }
        
        .hidden {
            display: none;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2, #667eea);
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .card, .customer-card, .transaction-item, .note-item, .average-card, .purchase-average-card, .expense-summary-card, .stock-item, .expense-item {
            animation: fadeIn 0.5s ease-out;
        }

        .sync-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .sync-status {
            flex: 1;
            font-size: 0.9rem;
            padding: 10px;
            border-radius: 20px;
            background: #f7fafc;
            color: #4a5568;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sync-status.online {
            color: #2ecc71;
            background: #e8f5e9;
        }
        
        .sync-status.offline {
            color: #e74c3c;
            background: #ffebee;
        }
        
        .sync-status.syncing {
            color: #f39c12;
            background: #fff3e0;
        }
        
        .sync-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: #fff;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.95rem;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
            white-space: nowrap;
        }
        
        .sync-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(52, 152, 219, 0.4);
        }
        
        .sync-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .detail-header {
            margin-bottom: 20px;
        }
        
        .detail-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .detail-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
        }
        
        .detail-contact h4 {
            font-size: 1.3rem;
            color: #2d3748;
            margin-bottom: 5px;
        }
        
        .detail-contact p {
            color: #718096;
            margin-bottom: 3px;
        }
        
        .customer-summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #f7fafc;
            border-radius: 20px;
            padding: 15px 10px;
            text-align: center;
        }
        
        .stat-card .label {
            font-size: 0.8rem;
            color: #718096;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        
        .stat-card .value {
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .stat-card .value.positive {
            color: #2ecc71;
        }
        
        .stat-card .value.negative {
            color: #e74c3c;
        }
        
        .modal-filter {
            margin: 20px 0;
        }
        
        .modal-date-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .modal-date-filter input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 18px;
            font-size: 0.95rem;
        }
        
        .modal-date-filter input:focus {
            border-color: #667eea;
            outline: none;
        }
        
        .trans-item {
            background: #fff;
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #edf2f7;
        }
        
        .trans-item .trans-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .trans-type {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .trans-type.inc-badge {
            background: #e8f5e9;
            color: #2ecc71;
        }
        
        .trans-type.exp-badge {
            background: #ffebee;
            color: #e74c3c;
        }
        
        .trans-amount {
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .trans-desc {
            color: #4a5568;
            margin: 8px 0;
        }
        
        .trans-time {
            font-size: 0.85rem;
            color: #718096;
            margin: 5px 0;
        }
        
        .trans-balance {
            font-size: 0.95rem;
            font-weight: 600;
            margin: 10px 0 5px;
            padding-top: 8px;
            border-top: 1px dashed #e2e8f0;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="app-header">
        <div class="header-top">
            <div class="company-name-left">Eunus Accounts System</div>
			<div class="company-name-left">Give And Take</div>
            <div class="company-name-right">
                <div class="mini-mart">à¦†à¦°à¦¾à¦¬à¦¿ à¦®à¦¿à¦¨à¦¿ à¦®à¦¾à¦°à§à¦Ÿ</div>
                <div class="owner-name">à¦®à§‹à¦ƒ à¦‡à¦‰à¦¨à§à¦¸</div>
				<div class="owner-name">à¦®à¦¾à¦²à¦¿à¦¤à¦¾, à¦šà¦°à¦¸à¦¿à¦¨à§à¦¦à§à¦°, à¦ªà¦²à¦¾à¦¶, à¦¨à¦°à¦¸à¦¿à¦‚à¦¦à§€à¥¤</div>
				<div class="owner-name">01931924031</div>
            </div>
        </div>
        <div class="header-divider"></div>
        <div class="system-title">à¦¬à¦¾à¦•à¦¿ à¦²à¦¿à¦–à¦¤à§‡ à¦¦à§‡à¦°à¦¿ à¦•à¦°à¦¬à§‡à¦¨ à¦¨à¦¾à¥¤</div>
    </div>

    <div class="sync-section">
        <div class="sync-status" id="syncStatus">
            <span id="syncIcon">ðŸ”Œ</span>
            <span id="syncText">à¦¸à¦‚à¦¯à§‹à¦— à¦ªà¦°à§€à¦•à§à¦·à¦¾ à¦•à¦°à¦¾ à¦¹à¦šà§à¦›à§‡...</span>
        </div>
        <button class="sync-btn" id="syncBtn" onclick="manualSync()">
            <span>ðŸ”„</span> à¦¸à¦¿à¦™à§à¦•
        </button>
    </div>

    
        <div id="floatingNotesList"></div>
    </div>

    <div class="main-tabs">
        <button class="main-tab inc-tab active" onclick="switchTab('transaction')" id="transactionTab">
            <span>âž•</span> à¦²à§‡à¦¨à¦¦à§‡à¦¨
        </button>
        <button class="main-tab" onclick="switchTab('customers')" id="customersTab">
            <span>ðŸ‘¥</span> à¦—à§à¦°à¦¾à¦¹à¦•
        </button>
        <button class="main-tab" onclick="switchTab('cash')" id="cashTab">
            <span>ðŸ’°</span> à¦•à§à¦¯à¦¾à¦¶
        </button>
        <button class="main-tab stock-tab" onclick="switchTab('stock')" id="stockTab">
            <span>ðŸ“¦</span> à¦•à§à¦°à§Ÿ à¦“ à¦¸à§à¦Ÿà¦•
        </button>
        <button class="main-tab expense-tab" onclick="switchTab('expense')" id="expenseTab">
            <span>ðŸ’¸</span> à¦–à¦°à¦š
        </button>
        <button class="main-tab profit-tab" onclick="switchTab('profit')" id="profitTab">
            <span>ðŸ“ˆ</span> à¦²à¦¾à¦­ à¦•à§à¦·à¦¤à¦¿
        </button>
        <button class="main-tab note-tab" onclick="switchTab('note')" id="noteTab">
            <span>ðŸ“</span> à¦¨à§‹à¦Ÿ
        </button>
    </div>

    <div id="transactionHeader" class="header-card">
        <div class="balance-show">
            <div class="balance-label">à¦¬à¦°à§à¦¤à¦®à¦¾à¦¨ à¦¬à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¸</div>
            <div class="balance-amount" id="bal">+0.00</div>
        </div>
    </div>

    <div id="cashHeader" class="cash-header hidden">
        <div class="cash-label">à¦®à§‹à¦Ÿ à¦•à§à¦¯à¦¾à¦¶</div>
        <div class="cash-total" id="cashTotalDisplay">à§¦.à§¦à§¦ à§³</div>
    </div>

    <!-- à¦²à§‡à¦¨à¦¦à§‡à¦¨ à¦¸à§‡à¦•à¦¶à¦¨ -->
    <div id="transactionSection">
        <div class="card">
            <div class="tab-nav">
                <button class="tab inc active" id="incBtn" onclick="setType('inc')">âž• à¦¦à¦¿à¦²à¦¾à¦®</button>
                <button class="tab exp" id="expBtn" onclick="setType('exp')">âž– à¦ªà§‡à¦²à¦¾à¦®</button>
            </div>

            <div class="customer-section">
                <div class="search-wrapper">
                    <span class="search-icon">ðŸ”</span>
                    <input type="text" id="srcCust" placeholder="à¦—à§à¦°à¦¾à¦¹à¦• à¦–à§à¦à¦œà§à¦¨..." onkeyup="filterCust()" onclick="showList()" autocomplete="off">
                </div>
                <div class="customer-list" id="custList"></div>
                <button class="btn-new" onclick="openNewCustomerModal()">
                    <span>ðŸ‘¤</span> à¦¨à¦¤à§à¦¨ à¦—à§à¦°à¦¾à¦¹à¦•
                </button>
                <input type="hidden" id="selCustId">
            </div>

            <div id="selectedCustInfo" style="margin:15px 0; display:none;">
                <div style="background:#e8f0fe; border-radius:20px; padding:15px; display:flex; align-items:center; gap:12px;">
                    <div style="width:45px;height:45px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:bold; font-size:1.2rem;" id="custInitial"></div>
                    <div>
                        <div style="font-weight:600; color:#2d3748;" id="selectedCustName"></div>
                        <div style="font-size:0.85rem;color:#718096;" id="selectedCustPhone"></div>
                    </div>
                </div>
            </div>

            <form id="tForm" onsubmit="saveTransaction(event)">
                <div class="form-group">
                    <label>à¦¬à¦¿à¦¬à¦°à¦£</label>
                    <div class="input-wrapper">
                        <span class="input-icon">ðŸ“</span>
                        <textarea id="desc" placeholder="à¦¬à¦¿à¦¬à¦°à¦£ à¦²à¦¿à¦–à§à¦¨..." required></textarea>
                    </div>
                </div>
                <div class="form-group">
                    <label>à¦ªà¦°à¦¿à¦®à¦¾à¦£</label>
                    <div class="input-wrapper">
                        <span class="input-icon">à§³</span>
                        <input type="number" id="amt" placeholder="0.00" required min="0" step="0.01">
                    </div>
                </div>
                <button type="submit" class="btn-save" id="svBtn">
                    <span>âœ”</span> à¦²à§‡à¦¨à¦¦à§‡à¦¨ à¦¸à¦‚à¦°à¦•à§à¦·à¦£
                </button>
            </form>
        </div>

        <!-- à¦«à¦¿à¦²à§à¦Ÿà¦¾à¦° à¦“ à¦…à¦¨à§à¦¸à¦¨à§à¦§à¦¾à¦¨ -->
        <div class="filter-section">
            <div class="search-wrapper" style="margin-bottom:15px;">
                <span class="search-icon">ðŸ”</span>
                <input type="text" id="transactionSearch" placeholder="à¦—à§à¦°à¦¾à¦¹à¦• à¦¬à¦¾ à¦¬à¦¿à¦¬à¦°à¦£ à¦–à§à¦à¦œà§à¦¨..." onkeyup="filterTransactions()">
            </div>

            <div class="balance-filter">
                <button class="bal-tag active" onclick="filterTransactionByType('all')" id="transFilterAll">à¦¸à¦¬</button>
                <button class="bal-tag positive" onclick="filterTransactionByType('inc')" id="transFilterInc">à¦¦à¦¿à¦²à¦¾à¦® (+)</button>
                <button class="bal-tag negative" onclick="filterTransactionByType('exp')" id="transFilterExp">à¦ªà§‡à¦²à¦¾à¦® (-)</button>
            </div>

            <div class="date-filter">
                <div class="date-input">
                    <label>à¦¥à§‡à¦•à§‡</label>
                    <input type="date" id="transFromDate">
                </div>
                <div class="date-input">
                    <label>à¦ªà¦°à§à¦¯à¦¨à§à¦¤</label>
                    <input type="date" id="transToDate">
                </div>
            </div>
            
            <div class="filter-actions">
                <button class="filter-btn apply-btn" onclick="applyTransactionDateFilter()">à¦«à¦¿à¦²à§à¦Ÿà¦¾à¦°</button>
                <button class="filter-btn reset-btn" onclick="resetTransactionDateFilter()">à¦°à¦¿à¦¸à§‡à¦Ÿ</button>
            </div>

            <div class="export-group">
                <button class="export-btn excel-btn" onclick="exportTransactionsToExcel()">ðŸ“Š Excel</button>
                <button class="export-btn txt-btn" onclick="exportTransactionsToTxt()">ðŸ“ TXT</button>
            </div>
        </div>

        <div id="transactionsList"></div>
    </div>

    <div id="customersSection" class="hidden">
        <div class="summary-grid">
            <div class="summary-item">
                <div class="summary-label">à¦®à§‹à¦Ÿ à¦—à§à¦°à¦¾à¦¹à¦•</div>
                <div class="summary-value" id="totalCustomers">0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">à¦®à§‹à¦Ÿ à¦¦à¦¿à¦²à¦¾à¦®</div>
                <div class="summary-value" id="totalGiven">0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">à¦®à§‹à¦Ÿ à¦ªà§‡à¦²à¦¾à¦®</div>
                <div class="summary-value" id="totalTaken">0</div>
            </div>
        </div>
        
        <div class="card" style="background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; margin-bottom:10px;">
            <div class="balance-show">
                <div class="balance-label">à¦—à§à¦°à¦¾à¦¹à¦• à¦Ÿà§à¦¯à¦¾à¦¬à§‡à¦° à¦¬à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¸</div>
                <div class="balance-amount" id="customerTabBalance">+0.00</div>
                <div style="font-size:0.9rem; opacity:0.8; margin-top:5px;">(à¦®à§‹à¦Ÿ à¦¦à¦¿à¦²à¦¾à¦® - à¦®à§‹à¦Ÿ à¦ªà§‡à¦²à¦¾à¦®)</div>
            </div>
        </div>

        <div class="filter-section">
            <div class="search-wrapper" style="margin-bottom:15px;">
                <span class="search-icon">ðŸ”</span>
                <input type="text" id="customerSearch" placeholder="à¦—à§à¦°à¦¾à¦¹à¦• à¦–à§à¦à¦œà§à¦¨..." onkeyup="filterCustomers()">
            </div>

            <div class="date-filter">
                <div class="date-input">
                    <label>à¦¥à§‡à¦•à§‡</label>
                    <input type="date" id="fromDate">
                </div>
                <div class="date-input">
                    <label>à¦ªà¦°à§à¦¯à¦¨à§à¦¤</label>
                    <input type="date" id="toDate">
                </div>
            </div>
            
            <div class="filter-actions">
                <button class="filter-btn apply-btn" onclick="applyDateFilter()">à¦«à¦¿à¦²à§à¦Ÿà¦¾à¦°</button>
                <button class="filter-btn reset-btn" onclick="resetDateFilter()">à¦°à¦¿à¦¸à§‡à¦Ÿ</button>
            </div>

            <div class="balance-filter">
                <button class="bal-tag active" onclick="filterByBalance('all')" id="filterAll">à¦¸à¦¬</button>
                <button class="bal-tag positive" onclick="filterByBalance('positive')" id="filterPositive">à¦ªà¦œà¦¿à¦Ÿà¦¿à¦­ (+)</button>
                <button class="bal-tag negative" onclick="filterByBalance('negative')" id="filterNegative">à¦¨à§‡à¦—à§‡à¦Ÿà¦¿à¦­ (-)</button>
                <button class="bal-tag" onclick="filterByBalance('zero')" id="filterZero">à¦¶à§‚à¦¨à§à¦¯ (à§¦)</button>
            </div>

            <div class="export-group">
                <button class="export-btn excel-btn" onclick="exportToExcel()">ðŸ“Š Excel</button>
                <button class="export-btn txt-btn" onclick="exportToTxt()">ðŸ“ TXT</button>
            </div>
        </div>

        <div id="customerList"></div>
    </div>

    <div id="cashSection" class="hidden">
        <div class="card">
            <h3 style="margin-bottom:15px;">ðŸ’° à¦•à§à¦¯à¦¾à¦¶ à¦‡à¦¨à¦ªà§à¦Ÿ</h3>
            
            <div class="form-group">
                <label>à¦¤à¦¾à¦°à¦¿à¦–</label>
                <input type="date" id="cashDate" value="" style="width:100%; padding:16px; border:2px solid #e2e8f0; border-radius:25px;">
            </div>
            
            <div class="cash-input-grid">
                <div class="cash-input-item">
                    <label>à§§à§¦à§¦à§¦ à§³</label>
                    <input type="number" id="note1000" value="0" min="0" onchange="calculateCashTotal()">
                </div>
                <div class="cash-input-item">
                    <label>à§«à§¦à§¦ à§³</label>
                    <input type="number" id="note500" value="0" min="0" onchange="calculateCashTotal()">
                </div>
                <div class="cash-input-item">
                    <label>à§¨à§¦à§¦ à§³</label>
                    <input type="number" id="note200" value="0" min="0" onchange="calculateCashTotal()">
                </div>
                <div class="cash-input-item">
                    <label>à§§à§¦à§¦ à§³</label>
                    <input type="number" id="note100" value="0" min="0" onchange="calculateCashTotal()">
                </div>
                <div class="cash-input-item">
                    <label>à§«à§¦ à§³</label>
                    <input type="number" id="note50" value="0" min="0" onchange="calculateCashTotal()">
                </div>
                <div class="cash-input-item">
                    <label>à§¨à§¦ à§³</label>
                    <input type="number" id="note20" value="0" min="0" onchange="calculateCashTotal()">
                </div>
                <div class="cash-input-item">
                    <label>à§§à§¦ à§³</label>
                    <input type="number" id="note10" value="0" min="0" onchange="calculateCashTotal()">
                </div>
                <div class="cash-input-item">
                    <label>à§« à§³</label>
                    <input type="number" id="note5" value="0" min="0" onchange="calculateCashTotal()">
                </div>
                <div class="cash-input-item">
                    <label>à§¨ à§³</label>
                    <input type="number" id="note2" value="0" min="0" onchange="calculateCashTotal()">
                </div>
                <div class="cash-input-item">
                    <label>à§§ à§³</label>
                    <input type="number" id="note1" value="0" min="0" onchange="calculateCashTotal()">
                </div>
                <div class="cash-input-item">
                    <label>à§«à§¦ à¦ªà§Ÿà¦¸à¦¾</label>
                    <input type="number" id="coin50" value="0" min="0" step="0.01" onchange="calculateCashTotal()">
                </div>
                <div class="cash-input-item">
                    <label>à§¨à§« à¦ªà§Ÿà¦¸à¦¾</label>
                    <input type="number" id="coin25" value="0" min="0" step="0.01" onchange="calculateCashTotal()">
                </div>
            </div>
            
            <button class="btn-save" onclick="saveCashData()" style="background:linear-gradient(135deg,#2ecc71,#27ae60); margin-top:15px;">
                <span>ðŸ’¾</span> à¦•à§à¦¯à¦¾à¦¶ à¦¸à¦‚à¦°à¦•à§à¦·à¦£
            </button>
        </div>
        
        <div class="filter-section">
            <div class="filter-title">ðŸ“… à¦¤à¦¾à¦°à¦¿à¦– à¦«à¦¿à¦²à§à¦Ÿà¦¾à¦°</div>
            <div class="date-filter">
                <div class="date-input">
                    <label>à¦¥à§‡à¦•à§‡</label>
                    <input type="date" id="cashFromDate">
                </div>
                <div class="date-input">
                    <label>à¦ªà¦°à§à¦¯à¦¨à§à¦¤</label>
                    <input type="date" id="cashToDate">
                </div>
            </div>
            <div class="filter-actions">
                <button class="filter-btn apply-btn" onclick="applyCashDateFilter()">à¦«à¦¿à¦²à§à¦Ÿà¦¾à¦°</button>
                <button class="filter-btn reset-btn" onclick="resetCashDateFilter()">à¦°à¦¿à¦¸à§‡à¦Ÿ</button>
            </div>
            
            <div style="background:#f8fafd; border-radius:20px; padding:15px; margin-top:15px; text-align:center;">
                <div class="cash-note">à¦«à¦¿à¦²à§à¦Ÿà¦¾à¦°à¦•à§ƒà¦¤ à¦®à§‹à¦Ÿ à¦•à§à¦¯à¦¾à¦¶</div>
                <div class="cash-total" style="color:#667eea; font-size:1.8rem;" id="filteredCashTotal">à§¦.à§¦à§¦ à§³</div>
            </div>

            <div class="export-group">
                <button class="export-btn excel-btn" onclick="exportCashToExcel()">ðŸ“Š Excel</button>
                <button class="export-btn txt-btn" onclick="exportCashToTxt()">ðŸ“ TXT</button>
            </div>
        </div>
        
        <div class="card">
            <h4 style="margin-bottom:15px;">ðŸ“Š à¦¬à¦¿à¦—à¦¤ à§­ à¦¦à¦¿à¦¨à§‡à¦° à¦•à§à¦¯à¦¾à¦¶</h4>
            <div class="past-cash-grid" id="pastCashGrid"></div>
        </div>
        
        <div class="average-cash-grid">
            <div class="average-card">
                <div class="average-label">à¦à¦‡ à¦®à¦¾à¦¸à§‡à¦° à¦—à¦¡à¦¼</div>
                <div class="average-value" id="thisMonthAvg">à§¦.à§¦à§¦</div>
                <div class="average-days" id="thisMonthDays">à§¦ à¦¦à¦¿à¦¨</div>
            </div>
            <div class="average-card">
                <div class="average-label">à¦—à¦¤ à¦®à¦¾à¦¸à§‡à¦° à¦—à¦¡à¦¼</div>
                <div class="average-value" id="lastMonthAvg">à§¦.à§¦à§¦</div>
                <div class="average-days" id="lastMonthDays">à§¦ à¦¦à¦¿à¦¨</div>
            </div>
        </div>
    </div>

    <div id="stockSection" class="hidden">
        <div class="stock-summary">
            <div class="total-stock" onclick="showAllStock()">
                ðŸ“Š à¦¬à¦°à§à¦¤à¦®à¦¾à¦¨ à¦¸à§à¦Ÿà¦•: <span id="totalStockValue">à§¦.à§¦à§¦</span> à§³
            </div>
            <button class="btn-new" onclick="openNewProductModal()" style="width:auto; padding:15px 20px;">
                <span>âž•</span> à¦¨à¦¤à§à¦¨ à¦ªà¦£à§à¦¯
            </button>
        </div>

        <div class="filter-section">
            <div class="search-wrapper" style="margin-bottom:15px;">
                <span class="search-icon">ðŸ”</span>
                <input type="text" id="productSearch" placeholder="à¦ªà¦£à§à¦¯à§‡à¦° à¦¨à¦¾à¦® à¦–à§à¦à¦œà§à¦¨..." onkeyup="filterProducts()">
            </div>

            <div class="date-filter">
                <div class="date-input">
                    <label>à¦¥à§‡à¦•à§‡</label>
                    <input type="date" id="stockFromDate">
                </div>
                <div class="date-input">
                    <label>à¦ªà¦°à§à¦¯à¦¨à§à¦¤</label>
                    <input type="date" id="stockToDate">
                </div>
            </div>
            
            <div class="filter-actions">
                <button class="filter-btn apply-btn" onclick="applyStockDateFilter()">à¦«à¦¿à¦²à§à¦Ÿà¦¾à¦°</button>
                <button class="filter-btn reset-btn" onclick="resetStockDateFilter()">à¦°à¦¿à¦¸à§‡à¦Ÿ</button>
            </div>

            <div class="export-group">
                <button class="export-btn excel-btn" onclick="exportStockToExcel()">ðŸ“Š Excel</button>
                <button class="export-btn txt-btn" onclick="exportStockToTxt()">ðŸ“ TXT</button>
            </div>
        </div>

        <div class="card">
            <h4 style="margin-bottom:15px;">ðŸ“Š à¦¬à¦¿à¦—à¦¤ à§­ à¦¦à¦¿à¦¨à§‡à¦° à¦•à§à¦°à§Ÿ</h4>
            <div class="past-cash-grid" id="pastPurchaseGrid"></div>
        </div>

        <div class="purchase-average-grid">
            <div class="purchase-average-card">
                <div class="purchase-average-label">à¦à¦‡ à¦®à¦¾à¦¸à§‡à¦° à¦®à§‹à¦Ÿ à¦•à§à¦°à§Ÿ</div>
                <div class="purchase-average-value" id="thisMonthPurchaseTotal">à§¦.à§¦à§¦</div>
                <div class="purchase-average-days" id="thisMonthPurchaseDays">à§¦ à¦Ÿà¦¿ à¦•à§à¦°à§Ÿ</div>
            </div>
            <div class="purchase-average-card">
                <div class="purchase-average-label">à¦—à¦¤ à¦®à¦¾à¦¸à§‡à¦° à¦®à§‹à¦Ÿ à¦•à§à¦°à§Ÿ</div>
                <div class="purchase-average-value" id="lastMonthPurchaseTotal">à§¦.à§¦à§¦</div>
                <div class="purchase-average-days" id="lastMonthPurchaseDays">à§¦ à¦Ÿà¦¿ à¦•à§à¦°à§Ÿ</div>
            </div>
        </div>

        <div id="productList"></div>
    </div>

    <div id="expenseSection" class="hidden">
        <div class="expense-summary">
            <div class="expense-summary-card">
                <div class="expense-summary-label">à¦à¦‡ à¦®à¦¾à¦¸à§‡à¦° à¦®à§‹à¦Ÿ à¦–à¦°à¦š</div>
                <div class="expense-summary-value" id="thisMonthExpense">à§¦.à§¦à§¦</div>
                <div class="expense-summary-days">à¦šà¦²à¦¤à¦¿ à¦®à¦¾à¦¸</div>
            </div>
            <div class="expense-summary-card">
                <div class="expense-summary-label">à¦—à¦¤ à¦®à¦¾à¦¸à§‡à¦° à¦®à§‹à¦Ÿ à¦–à¦°à¦š</div>
                <div class="expense-summary-value" id="lastMonthExpense">à§¦.à§¦à§¦</div>
                <div class="expense-summary-days">à¦—à¦¤ à¦®à¦¾à¦¸</div>
            </div>
        </div>

        <button class="btn-new" onclick="openNewExpenseModal()" style="margin-bottom:15px;">
            <span>âž•</span> à¦¨à¦¤à§à¦¨ à¦–à¦°à¦š
        </button>

        <div class="filter-section">
            <div class="search-wrapper" style="margin-bottom:15px;">
                <span class="search-icon">ðŸ”</span>
                <input type="text" id="expenseSearch" placeholder="à¦–à¦°à¦šà§‡à¦° à¦¨à¦¾à¦® à¦–à§à¦à¦œà§à¦¨..." onkeyup="filterExpenses()">
            </div>

            <div class="date-filter">
                <div class="date-input">
                    <label>à¦¥à§‡à¦•à§‡</label>
                    <input type="date" id="expenseFromDate">
                </div>
                <div class="date-input">
                    <label>à¦ªà¦°à§à¦¯à¦¨à§à¦¤</label>
                    <input type="date" id="expenseToDate">
                </div>
            </div>
            
            <div class="filter-actions">
                <button class="filter-btn apply-btn" onclick="applyExpenseDateFilter()">à¦«à¦¿à¦²à§à¦Ÿà¦¾à¦°</button>
                <button class="filter-btn reset-btn" onclick="resetExpenseDateFilter()">à¦°à¦¿à¦¸à§‡à¦Ÿ</button>
            </div>

            <div class="export-group">
                <button class="export-btn excel-btn" onclick="exportExpensesToExcel()">ðŸ“Š Excel</button>
                <button class="export-btn txt-btn" onclick="exportExpensesToTxt()">ðŸ“ TXT</button>
            </div>
        </div>

        <div class="card">
            <h4 style="margin-bottom:15px;">ðŸ“Š à¦¬à¦¿à¦—à¦¤ à§­ à¦¦à¦¿à¦¨à§‡à¦° à¦–à¦°à¦š</h4>
            <div class="past-cash-grid" id="pastExpenseGrid"></div>
        </div>

        <div id="expenseList"></div>
    </div>

    <!-- à¦²à¦¾à¦­-à¦•à§à¦·à¦¤à¦¿ à¦¸à§‡à¦•à¦¶à¦¨ - à¦†à¦ªà¦¡à§‡à¦Ÿà§‡à¦¡ (à¦®à¦¾à¦¸à¦¿à¦• à¦“ à¦¬à¦¾à¦°à§à¦·à¦¿à¦• à¦…à¦‚à¦¶ à¦¸à¦°à¦¾à¦¨à§‹ à¦¹à§Ÿà§‡à¦›à§‡) -->
    <div id="profitSection" class="hidden">
        <div class="card">
            <h3 style="margin-bottom:15px;">ðŸ“ˆ à¦ªà§à¦°à¦¾à¦¥à¦®à¦¿à¦• à¦ªà§à¦à¦œà¦¿</h3>
            <div class="form-group">
                <label>à¦¤à¦¾à¦°à¦¿à¦– à¦¨à¦¿à¦°à§à¦¬à¦¾à¦šà¦¨ à¦•à¦°à§à¦¨</label>
                <input type="date" id="capitalDate" value="" style="width:100%; padding:16px; border:2px solid #e2e8f0; border-radius:25px;">
            </div>
            <div class="form-group">
                <label>à¦ªà§à¦°à¦¾à¦¥à¦®à¦¿à¦• à¦ªà§à¦à¦œà¦¿à¦° à¦ªà¦°à¦¿à¦®à¦¾à¦£</label>
                <div class="input-wrapper">
                    <span class="input-icon">ðŸ’°</span>
                    <input type="number" id="initialCapital" step="0.01" min="0" value="0" placeholder="0.00">
                </div>
            </div>
            <button class="btn-save" onclick="saveInitialCapital()" style="background:linear-gradient(135deg,#9b59b6,#8e44ad);">
                <span>ðŸ’¾</span> à¦ªà§à¦à¦œà¦¿ à¦¸à¦‚à¦°à¦•à§à¦·à¦£
            </button>
        </div>

        <div class="filter-section">
            <div class="filter-title">ðŸ“… à¦¤à¦¾à¦°à¦¿à¦– à¦«à¦¿à¦²à§à¦Ÿà¦¾à¦°</div>
            <div class="date-filter">
                <div class="date-input">
                    <label>à¦¥à§‡à¦•à§‡</label>
                    <input type="date" id="profitFromDate">
                </div>
                <div class="date-input">
                    <label>à¦ªà¦°à§à¦¯à¦¨à§à¦¤</label>
                    <input type="date" id="profitToDate">
                </div>
            </div>
            
            <div class="filter-actions">
                <button class="filter-btn apply-btn" onclick="applyProfitDateFilter()">à¦«à¦¿à¦²à§à¦Ÿà¦¾à¦°</button>
                <button class="filter-btn reset-btn" onclick="resetProfitDateFilter()">à¦°à¦¿à¦¸à§‡à¦Ÿ</button>
            </div>

            <div class="date-filter-result" id="profitDateFilterResult">
                <div class="filter-result-title">ðŸ“Š à¦«à¦¿à¦²à§à¦Ÿà¦¾à¦°à¦•à§ƒà¦¤ à¦«à¦²à¦¾à¦«à¦²</div>
                <div class="filter-result-item">
                    <span class="filter-result-label">à¦®à§‹à¦Ÿ à¦•à§à¦¯à¦¾à¦¶:</span>
                    <span class="filter-result-value" id="filterCash">à§¦.à§¦à§¦</span>
                </div>
                <div class="filter-result-item">
                    <span class="filter-result-label">à¦—à§à¦°à¦¾à¦¹à¦• à¦¬à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¸:</span>
                    <span class="filter-result-value" id="filterCustomer">à§¦.à§¦à§¦</span>
                </div>
                <div class="filter-result-item">
                    <span class="filter-result-label">à¦¸à§à¦Ÿà¦• à¦®à§‚à¦²à§à¦¯:</span>
                    <span class="filter-result-value" id="filterStock">à§¦.à§¦à§¦</span>
                </div>
                <div class="filter-result-item">
                    <span class="filter-result-label">à¦®à§‹à¦Ÿ à¦¸à¦®à§à¦ªà¦¦:</span>
                    <span class="filter-result-value" id="filterTotalAssets">à§¦.à§¦à§¦</span>
                </div>
                <div class="filter-result-item">
                    <span class="filter-result-label">à¦ªà§à¦°à¦¾à¦¥à¦®à¦¿à¦• à¦ªà§à¦à¦œà¦¿:</span>
                    <span class="filter-result-value" id="filterInitialCapital">à§¦.à§¦à§¦</span>
                </div>
                <div class="filter-result-item">
                    <span class="filter-result-label">à¦®à§‹à¦Ÿ à¦–à¦°à¦š:</span>
                    <span class="filter-result-value" id="filterExpenses">à§¦.à§¦à§¦</span>
                </div>
                <div class="filter-result-item" style="border-top:2px dashed #e2e8f0; margin-top:8px; padding-top:8px;">
                    <span class="filter-result-label" style="font-weight:700;">à¦¨à¦¿à¦Ÿ à¦«à¦²à¦¾à¦«à¦²:</span>
                    <span class="filter-result-value" style="font-weight:700;" id="filterNetResult">à§¦.à§¦à§¦</span>
                </div>
            </div>

            <div class="export-group">
                <button class="export-btn excel-btn" onclick="exportProfitFilterToExcel()">ðŸ“Š Excel</button>
                <button class="export-btn txt-btn" onclick="exportProfitFilterToTxt()">ðŸ“ TXT</button>
            </div>
        </div>

        <div class="profit-card">
            <div class="profit-result">
                <div class="profit-label">à¦¬à¦°à§à¦¤à¦®à¦¾à¦¨ à¦²à¦¾à¦­/à¦•à§à¦·à¦¤à¦¿</div>
                <div class="profit-amount" id="profitLossAmount">+à§¦.à§¦à§¦</div>
                <div style="font-size:1rem; opacity:0.9; margin-top:8px;" id="profitLossStatus">(à¦²à¦¾à¦­)</div>
            </div>
        </div>

        <div class="calculation-card">
            <div class="calculation-item">
                <span class="calculation-label">ðŸ’° à¦†à¦œà¦•à§‡à¦° à¦®à§‹à¦Ÿ à¦•à§à¦¯à¦¾à¦¶</span>
                <span class="calculation-value" id="calcTodayCash">à§¦.à§¦à§¦</span>
            </div>
            <div class="calculation-item">
                <span class="calculation-label">ðŸ‘¥ à¦—à§à¦°à¦¾à¦¹à¦• à¦¬à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¸</span>
                <span class="calculation-value" id="calcCustomerBalance">à§¦.à§¦à§¦</span>
            </div>
            <div class="calculation-item">
                <span class="calculation-label">ðŸ“¦ à¦¬à¦°à§à¦¤à¦®à¦¾à¦¨ à¦¸à§à¦Ÿà¦•</span>
                <span class="calculation-value" id="calcStockValue">à§¦.à§¦à§¦</span>
            </div>
            <div class="calculation-item">
                <span class="calculation-label">âž• à¦®à§‹à¦Ÿ à¦¸à¦®à§à¦ªà¦¦</span>
                <span class="calculation-value" style="font-weight:700;" id="calcTotalAssets">à§¦.à§¦à§¦</span>
            </div>
            <div class="calculation-item">
                <span class="calculation-label">âž– à¦ªà§à¦°à¦¾à¦¥à¦®à¦¿à¦• à¦ªà§à¦à¦œà¦¿</span>
                <span class="calculation-value" id="calcInitialCapital">à§¦.à§¦à§¦</span>
            </div>
            <div class="calculation-item">
                <span class="calculation-label">âž– à¦à¦‡ à¦®à¦¾à¦¸à§‡à¦° à¦–à¦°à¦š</span>
                <span class="calculation-value" id="calcThisMonthExpense">à§¦.à§¦à§¦</span>
            </div>
            <div class="calculation-item" style="border-bottom:none; margin-top:12px; padding-top:12px; border-top:3px solid #9b59b6;">
                <span class="calculation-label" style="font-weight:700;">ðŸ“Š à¦¨à¦¿à¦Ÿ à¦«à¦²à¦¾à¦«à¦²</span>
                <span class="calculation-value" style="font-weight:700; font-size:1.4rem;" id="calcNetResult">à§¦.à§¦à§¦</span>
            </div>
        </div>
    </div>

    <!-- à¦¨à§‹à¦Ÿ à¦¸à§‡à¦•à¦¶à¦¨ -->
    <div id="noteSection" class="hidden">
        <div class="card">
            <h3 style="margin-bottom:15px;">ðŸ“ à¦¨à§‹à¦Ÿ</h3>
            
            <div class="form-group">
                <label>à¦†à¦ªà¦¨à¦¾à¦° à¦¨à§‹à¦Ÿ à¦²à¦¿à¦–à§à¦¨</label>
                <div class="input-wrapper">
                    <span class="input-icon">ðŸ“</span>
                    <textarea id="noteContent" placeholder="à¦†à¦ªà¦¨à¦¾à¦° à¦¨à§‹à¦Ÿ à¦²à¦¿à¦–à§à¦¨..." rows="4"></textarea>
                </div>
            </div>
            
            <button class="btn-save" onclick="saveNote()" style="background:linear-gradient(135deg,#f1c40f,#f39c12);">
                <span>ðŸ’¾</span> à¦¨à§‹à¦Ÿ à¦¸à¦‚à¦°à¦•à§à¦·à¦£
            </button>
        </div>

        <div class="filter-section">
            <div class="search-wrapper" style="margin-bottom:15px;">
                <span class="search-icon">ðŸ”</span>
                <input type="text" id="noteSearch" placeholder="à¦¨à§‹à¦Ÿ à¦–à§à¦à¦œà§à¦¨..." onkeyup="filterNotes()">
            </div>

            <div class="date-filter">
                <div class="date-input">
                    <label>à¦¥à§‡à¦•à§‡</label>
                    <input type="date" id="noteFromDate">
                </div>
                <div class="date-input">
                    <label>à¦ªà¦°à§à¦¯à¦¨à§à¦¤</label>
                    <input type="date" id="noteToDate">
                </div>
            </div>
            
            <div class="filter-actions">
                <button class="filter-btn apply-btn" onclick="applyNoteDateFilter()">à¦«à¦¿à¦²à§à¦Ÿà¦¾à¦°</button>
                <button class="filter-btn reset-btn" onclick="resetNoteDateFilter()">à¦°à¦¿à¦¸à§‡à¦Ÿ</button>
            </div>

            <div class="export-group">
                <button class="export-btn txt-btn" onclick="exportNotesToTxt()">ðŸ“ TXT à¦à¦•à§à¦¸à¦ªà§‹à¦°à§à¦Ÿ</button>
            </div>
        </div>

        

        <div id="notesList"></div>
    </div>

    <div class="modal" id="newProductModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="productModalTitle">à¦¨à¦¤à§à¦¨ à¦ªà¦£à§à¦¯ à¦•à§à¦°à§Ÿ</h3>
                <button class="close-btn" onclick="closeNewProductModal()">âœ•</button>
            </div>
            <form onsubmit="saveProduct(event)">
                <div class="form-group">
                    <label>à¦¤à¦¾à¦°à¦¿à¦–</label>
                    <input type="date" id="productDate" value="" required style="width:100%; padding:16px; border:2px solid #e2e8f0; border-radius:25px;">
                </div>
                <div class="form-group">
                    <label>à¦ªà¦£à§à¦¯à§‡à¦° à¦¨à¦¾à¦®</label>
                    <div class="input-wrapper" style="position:relative;">
                        <span class="input-icon">ðŸ“¦</span>
                        <input type="text" id="productName" placeholder="à¦¨à¦¾à¦® à¦²à¦¿à¦–à§à¦¨ à¦¬à¦¾ à¦–à§à¦à¦œà§à¦¨..." onkeyup="searchProductName()" onclick="showProductDropdown()" autocomplete="off" required>
                    </div>
                    <div class="customer-list" id="productNameList" style="position:relative; margin-top:0;"></div>
                </div>
                <div class="form-group">
                    <label>à¦ªà¦°à¦¿à¦®à¦¾à¦£</label>
                    <div class="input-wrapper">
                        <span class="input-icon">âš–ï¸</span>
                        <input type="number" id="productQty" step="0.01" min="0.01" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>à¦à¦•à¦•</label>
                    <div class="input-wrapper">
                        <span class="input-icon">ðŸ“</span>
                        <select id="productUnit" required>
                            <option value="à¦•à§‡à¦œà¦¿">à¦•à§‡à¦œà¦¿</option>
                            <option value="à¦ªà¦¿à¦›">à¦ªà¦¿à¦›</option>
                            <option value="à¦²à¦¿à¦Ÿà¦¾à¦°">à¦²à¦¿à¦Ÿà¦¾à¦°</option>
                            <option value="à¦¹à¦¾à¦²à¦¿">à¦¹à¦¾à¦²à¦¿</option>
                            <option value="à¦¡à¦œà¦¨">à¦¡à¦œà¦¨</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>à¦¬à¦¿à¦¬à¦°à¦£</label>
                    <div class="input-wrapper">
                        <span class="input-icon">ðŸ“</span>
                        <textarea id="productDesc" placeholder="à¦¬à¦¿à¦¬à¦°à¦£ (à¦à¦šà§à¦›à¦¿à¦•)"></textarea>
                    </div>
                </div>
                <div class="form-group">
                    <label>à¦•à§à¦°à§Ÿ à¦®à§‚à¦²à§à¦¯ (à¦ªà§à¦°à¦¤à¦¿ à¦à¦•à¦•)</label>
                    <div class="input-wrapper">
                        <span class="input-icon">à§³</span>
                        <input type="number" id="purchasePrice" step="0.01" min="0" required onchange="calculateProfit()">
                    </div>
                </div>
                <div class="form-group">
                    <label>à¦¬à¦¿à¦•à§à¦°à§Ÿ à¦®à§‚à¦²à§à¦¯ (à¦ªà§à¦°à¦¤à¦¿ à¦à¦•à¦•)</label>
                    <div class="input-wrapper">
                        <span class="input-icon">à§³</span>
                        <input type="number" id="sellPrice" step="0.01" min="0" required onchange="calculateProfit()">
                    </div>
                </div>
                <div class="form-group">
                    <label>à¦®à§‹à¦Ÿ à¦²à¦¾à¦­</label>
                    <div class="input-wrapper">
                        <span class="input-icon">ðŸ’°</span>
                        <input type="number" id="profitAmount" step="0.01" readonly style="background:#f0f0f0;">
                    </div>
                </div>
                <button type="submit" class="btn-save" style="background:linear-gradient(135deg,#e67e22,#d35400);" id="saveProductBtn">
                    <span>âœ”</span> à¦•à§à¦°à§Ÿ à¦¸à¦‚à¦°à¦•à§à¦·à¦£
                </button>
            </form>
        </div>
    </div>

    <div class="modal" id="newExpenseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="expenseModalTitle">à¦¨à¦¤à§à¦¨ à¦–à¦°à¦š</h3>
                <button class="close-btn" onclick="closeNewExpenseModal()">âœ•</button>
            </div>
            <form onsubmit="saveExpense(event)">
                <div class="form-group">
                    <label>à¦¤à¦¾à¦°à¦¿à¦–</label>
                    <input type="date" id="expenseDate" value="" required style="width:100%; padding:16px; border:2px solid #e2e8f0; border-radius:25px;">
                </div>
                <div class="form-group">
                    <label>à¦–à¦°à¦šà§‡à¦° à¦¨à¦¾à¦®</label>
                    <div class="input-wrapper">
                        <span class="input-icon">ðŸ“</span>
                        <input type="text" id="expenseName" placeholder="à¦¯à§‡à¦®à¦¨: à¦¬à¦¿à¦¦à§à¦¯à§à§Ž à¦¬à¦¿à¦²" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>à¦ªà¦°à¦¿à¦®à¦¾à¦£</label>
                    <div class="input-wrapper">
                        <span class="input-icon">à§³</span>
                        <input type="number" id="expenseAmount" step="0.01" min="0.01" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>à¦¬à¦¿à¦¬à¦°à¦£ (à¦à¦šà§à¦›à¦¿à¦•)</label>
                    <div class="input-wrapper">
                        <span class="input-icon">ðŸ“‹</span>
                        <textarea id="expenseDesc" placeholder="à¦¬à¦¿à¦¬à¦°à¦£..."></textarea>
                    </div>
                </div>
                <button type="submit" class="btn-save" style="background:linear-gradient(135deg,#e74c3c,#c0392b);" id="saveExpenseBtn">
                    <span>âœ”</span> à¦–à¦°à¦š à¦¸à¦‚à¦°à¦•à§à¦·à¦£
                </button>
            </form>
        </div>
    </div>

    <div class="modal" id="newCustomerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>à¦¨à¦¤à§à¦¨ à¦—à§à¦°à¦¾à¦¹à¦•</h3>
                <button class="close-btn" onclick="closeNewCustomerModal()">âœ•</button>
            </div>
            <form onsubmit="saveNewCustomer(event)">
                <div class="form-group">
                    <label>à¦¨à¦¾à¦®</label>
                    <div class="input-wrapper">
                        <span class="input-icon">ðŸ‘¤</span>
                        <input type="text" id="newCustName" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>à¦«à§‹à¦¨</label>
                    <div class="input-wrapper">
                        <span class="input-icon">ðŸ“ž</span>
                        <input type="text" id="newCustPhone">
                    </div>
                </div>
                <div class="form-group">
                    <label>à¦ à¦¿à¦•à¦¾à¦¨à¦¾</label>
                    <div class="input-wrapper">
                        <span class="input-icon">ðŸ“</span>
                        <input type="text" id="newCustAddr">
                    </div>
                </div>
                <button type="submit" class="btn-save" style="background:linear-gradient(135deg,#2ecc71,#27ae60);">à¦¸à¦‚à¦°à¦•à§à¦·à¦£</button>
            </form>
        </div>
    </div>

    <div class="modal" id="editNoteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>à¦¨à§‹à¦Ÿ à¦¸à¦®à§à¦ªà¦¾à¦¦à¦¨à¦¾</h3>
                <button class="close-btn" onclick="closeEditNoteModal()">âœ•</button>
            </div>
            <div class="form-group">
                <label>à¦¨à§‹à¦Ÿ</label>
                <div class="input-wrapper">
                    <span class="input-icon">ðŸ“</span>
                    <textarea id="editNoteContent" placeholder="à¦†à¦ªà¦¨à¦¾à¦° à¦¨à§‹à¦Ÿ à¦²à¦¿à¦–à§à¦¨..." rows="4"></textarea>
                </div>
            </div>
            <button class="btn-save" onclick="updateNote()" style="background:linear-gradient(135deg,#f1c40f,#f39c12);">
                <span>âœ”</span> à¦†à¦ªà¦¡à§‡à¦Ÿ
            </button>
        </div>
    </div>

    <div class="modal" id="customerDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="detailModalTitle">à¦—à§à¦°à¦¾à¦¹à¦• à¦¬à¦¿à¦¬à¦°à¦£</h3>
                <button class="close-btn" onclick="closeDetailModal()">âœ•</button>
            </div>
            
            <div id="customerDetailContent"></div>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { 
    getFirestore, 
    collection, 
    doc, 
    getDocs, 
    setDoc, 
    deleteDoc,
    writeBatch,
    getDoc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyC3osNtpz4Yi5pGR6Zvlb-y2J-oTppwXJ0",
    authDomain: "eunus-accounts-system-1.firebaseapp.com",
    projectId: "eunus-accounts-system-1",
    storageBucket: "eunus-accounts-system-1.firebasestorage.app",
    messagingSenderId: "137968926428",
    appId: "1:137968926428:web:3e74539cfeb4b1ab9afe19"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let isOnline = navigator.onLine;
let isSyncing = false;
let pendingSync = false;

const syncStatus = document.getElementById('syncStatus');
const syncIcon = document.getElementById('syncIcon');
const syncText = document.getElementById('syncText');
const syncBtn = document.getElementById('syncBtn');

window.addEventListener('online', () => {
    isOnline = true;
    updateSyncStatus();
    if (pendingSync) {
        autoSync();
    }
});

window.addEventListener('offline', () => {
    isOnline = false;
    updateSyncStatus();
});

function updateSyncStatus() {
    if (isSyncing) {
        syncStatus.className = 'sync-status syncing';
        syncIcon.textContent = 'ðŸ”„';
        syncText.textContent = 'à¦¸à¦¿à¦™à§à¦• à¦¹à¦šà§à¦›à§‡...';
        syncBtn.disabled = true;
    } else if (isOnline) {
        syncStatus.className = 'sync-status online';
        syncIcon.textContent = 'âœ…';
        syncText.textContent = 'à¦…à¦¨à¦²à¦¾à¦‡à¦¨';
        syncBtn.disabled = false;
    } else {
        syncStatus.className = 'sync-status offline';
        syncIcon.textContent = 'âš ï¸';
        syncText.textContent = 'à¦…à¦«à¦²à¦¾à¦‡à¦¨';
        syncBtn.disabled = false;
    }
}

async function autoSync() {
    if (!isOnline || isSyncing) return;
    pendingSync = true;
    await syncToFirebase();
}

window.manualSync = async function() {
    if (!isOnline) {
        alert('à¦‡à¦¨à§à¦Ÿà¦¾à¦°à¦¨à§‡à¦Ÿ à¦¸à¦‚à¦¯à§‹à¦— à¦¨à§‡à¦‡à¥¤ à¦…à¦¨à¦²à¦¾à¦‡à¦¨à§‡ à¦¹à¦²à§‡ à¦¸à¦¿à¦™à§à¦• à¦•à¦°à§à¦¨à¥¤');
        return;
    }
    await syncToFirebase();
}

async function syncToFirebase() {
    if (isSyncing) return;
    
    isSyncing = true;
    updateSyncStatus();
    
    try {
        const batch = writeBatch(db);
        const timestamp = new Date().toISOString();
        
        const transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        const transactionsRef = collection(db, 'transactions');
        const existingTransactions = await getDocs(transactionsRef);
        existingTransactions.forEach(doc => {
            // batch.delete (disabled for safe merge)(doc.ref);
        });
        transactions.forEach(t => {
            const docRef = doc(transactionsRef, t.id);
            batch.set(docRef, { ...t, lastSynced: timestamp });
        });
        
        const customers = JSON.parse(localStorage.getItem('customers')) || [];
        const customersRef = collection(db, 'customers');
        const existingCustomers = await getDocs(customersRef);
        existingCustomers.forEach(doc => {
            // batch.delete (disabled for safe merge)(doc.ref);
        });
        customers.forEach(c => {
            const docRef = doc(customersRef, c.id);
            batch.set(docRef, { ...c, lastSynced: timestamp });
        });
        
        const cashData = JSON.parse(localStorage.getItem('cashData')) || [];
        const cashRef = collection(db, 'cashData');
        const existingCash = await getDocs(cashRef);
        existingCash.forEach(doc => {
            // batch.delete (disabled for safe merge)(doc.ref);
        });
        cashData.forEach(c => {
            const docRef = doc(cashRef, c.date);
            batch.set(docRef, { ...c, lastSynced: timestamp });
        });
        
        const products = JSON.parse(localStorage.getItem('products')) || [];
        const productsRef = collection(db, 'products');
        const existingProducts = await getDocs(productsRef);
        existingProducts.forEach(doc => {
            // batch.delete (disabled for safe merge)(doc.ref);
        });
        products.forEach(p => {
            const docRef = doc(productsRef, p.id);
            batch.set(docRef, { ...p, lastSynced: timestamp });
        });
        
        const expenses = JSON.parse(localStorage.getItem('expenses')) || [];
        const expensesRef = collection(db, 'expenses');
        const existingExpenses = await getDocs(expensesRef);
        existingExpenses.forEach(doc => {
            // batch.delete (disabled for safe merge)(doc.ref);
        });
        expenses.forEach(e => {
            const docRef = doc(expensesRef, e.id);
            batch.set(docRef, { ...e, lastSynced: timestamp });
        });
        
        const notes = JSON.parse(localStorage.getItem('notes')) || [];
        const notesRef = collection(db, 'notes');
        const existingNotes = await getDocs(notesRef);
        existingNotes.forEach(doc => {
            // batch.delete (disabled for safe merge)(doc.ref);
        });
        notes.forEach(n => {
            const docRef = doc(notesRef, n.id);
            batch.set(docRef, { ...n, lastSynced: timestamp });
        });
        
        const selectedNotes = JSON.parse(localStorage.getItem('selectedNotes')) || [];
        const selectedNotesRef = collection(db, 'selectedNotes');
        const existingSelected = await getDocs(selectedNotesRef);
        existingSelected.forEach(doc => {
            // batch.delete (disabled for safe merge)(doc.ref);
        });
        selectedNotes.forEach(n => {
            const docRef = doc(selectedNotesRef, n.id);
            batch.set(docRef, { ...n, lastSynced: timestamp });
        });
        
        const initialCapital = JSON.parse(localStorage.getItem('initialCapital')) || { date: getBangladeshDateForInput(), amount: 0 };
        const capitalRef = doc(db, 'settings', 'initialCapital');
        batch.set(capitalRef, { ...initialCapital, lastSynced: timestamp });
        
        // await batch.commit(); disabled
        
        pendingSync = false;
        alert('à¦¸à¦•à¦² à¦¡à¦¾à¦Ÿà¦¾ à¦¸à¦«à¦²à¦­à¦¾à¦¬à§‡ Firebase-à¦ à¦¸à¦¿à¦™à§à¦• à¦¹à¦¯à¦¼à§‡à¦›à§‡!');
        
    } catch (error) {
        console.error('Sync error:', error);
        alert('à¦¸à¦¿à¦™à§à¦• à¦•à¦°à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡à¥¤ à¦†à¦¬à¦¾à¦° à¦šà§‡à¦·à§à¦Ÿà¦¾ à¦•à¦°à§à¦¨à¥¤');
        pendingSync = true;
    } finally {
        isSyncing = false;
        updateSyncStatus();
    }
}

async function loadFromFirebase() {
    if (!isOnline) return;
    
    try {
        const transactionsSnapshot = await getDocs(collection(db, 'transactions'));
        if (!transactionsSnapshot.empty) {
            const transactions = [];
            transactionsSnapshot.forEach(doc => {
                transactions.push(doc.data());
            });
            localStorage.setItem('transactions', JSON.stringify(transactions));
        }
        
        const customersSnapshot = await getDocs(collection(db, 'customers'));
        if (!customersSnapshot.empty) {
            const customers = [];
            customersSnapshot.forEach(doc => {
                customers.push(doc.data());
            });
            localStorage.setItem('customers', JSON.stringify(customers));
        }
        
        const cashSnapshot = await getDocs(collection(db, 'cashData'));
        if (!cashSnapshot.empty) {
            const cashData = [];
            cashSnapshot.forEach(doc => {
                cashData.push(doc.data());
            });
            localStorage.setItem('cashData', JSON.stringify(cashData));
        }
        
        const productsSnapshot = await getDocs(collection(db, 'products'));
        if (!productsSnapshot.empty) {
            const products = [];
            productsSnapshot.forEach(doc => {
                products.push(doc.data());
            });
            localStorage.setItem('products', JSON.stringify(products));
        }
        
        const expensesSnapshot = await getDocs(collection(db, 'expenses'));
        if (!expensesSnapshot.empty) {
            const expenses = [];
            expensesSnapshot.forEach(doc => {
                expenses.push(doc.data());
            });
            localStorage.setItem('expenses', JSON.stringify(expenses));
        }
        
        const notesSnapshot = await getDocs(collection(db, 'notes'));
        if (!notesSnapshot.empty) {
            const notes = [];
            notesSnapshot.forEach(doc => {
                notes.push(doc.data());
            });
            localStorage.setItem('notes', JSON.stringify(notes));
        }
        
        const selectedSnapshot = await getDocs(collection(db, 'selectedNotes'));
        if (!selectedSnapshot.empty) {
            const selectedNotes = [];
            selectedSnapshot.forEach(doc => {
                selectedNotes.push(doc.data());
            });
            localStorage.setItem('selectedNotes', JSON.stringify(selectedNotes));
        }
        
        const capitalDoc = await getDoc(doc(db, 'settings', 'initialCapital'));
        if (capitalDoc.exists()) {
            localStorage.setItem('initialCapital', JSON.stringify(capitalDoc.data()));
        }
        
        init();
        
    } catch (error) {
        console.error('Load error:', error);
    }
}

// ==================== à¦¡à¦¾à¦Ÿà¦¾ à¦¸à§à¦Ÿà§‹à¦°à§‡à¦œ ====================

let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
let customers = JSON.parse(localStorage.getItem('customers')) || [];
let cashData = JSON.parse(localStorage.getItem('cashData')) || [];
let products = JSON.parse(localStorage.getItem('products')) || [];
let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
let notes = JSON.parse(localStorage.getItem('notes')) || [];
let selectedNotes = JSON.parse(localStorage.getItem('selectedNotes')) || [];
let initialCapitalData = JSON.parse(localStorage.getItem('initialCapital')) || { date: getBangladeshDateForInput(), amount: 0 };
let selectedCustomer = null;
let transactionType = 'inc';
let editingId = null;
let editingProductId = null;
let editingExpenseId = null;
let editingNoteId = null;
let currentFilter = 'all';
let currentDateFilter = { from: '', to: '' };
let currentCustomer = null;
let cashDateFilter = { from: '', to: '' };
let stockDateFilter = { from: '', to: '' };
let expenseDateFilter = { from: '', to: '' };
let profitDateFilter = { from: '', to: '' };
let noteDateFilter = { from: '', to: '' };
let stockSearchTerm = '';
let expenseSearchTerm = '';
let transactionSearchTerm = '';
let noteSearchTerm = '';
let transactionTypeFilter = 'all';
let transactionDateFilter = { from: '', to: '' };

const companyHeader = `Eunus Accounts System Give & Take
à¦†à¦°à¦¾à¦¬à¦¿ à¦®à¦¿à¦¨à¦¿ à¦®à¦¾à¦°à§à¦Ÿ
à¦®à§‹à¦ƒ à¦‡à¦‰à¦¨à§à¦¸ 
à¦®à¦¾à¦²à¦¿à¦¤à¦¾, à¦šà¦°à¦¸à¦¿à¦¨à§à¦¦à§à¦°, à¦ªà¦²à¦¾à¦¶, à¦¨à¦°à¦¸à¦¿à¦‚à¦¦à§€à¥¤
à¦«à§‹à¦¨, à¦‡à¦®à§, à¦¹à§‹à§Ÿà¦¾à¦Ÿà¦¸à¦…à§à¦¯à¦¾à¦ª - 01931924031
à¦«à§‡à¦¸à¦¬à§à¦• à¦¸à¦¾à¦°à§à¦š Arabi Mini Mart
===========================================
`;

function getBangladeshDateForInput() {
    const now = new Date();
    const bdTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Dhaka' }));
    const year = bdTime.getFullYear();
    const month = String(bdTime.getMonth() + 1).padStart(2, '0');
    const day = String(bdTime.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function getBangladeshDateTime() {
    const now = new Date();
    const bdTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Dhaka' }));
    const year = bdTime.getFullYear();
    const month = String(bdTime.getMonth() + 1).padStart(2, '0');
    const day = String(bdTime.getDate()).padStart(2, '0');
    const hours = String(bdTime.getHours()).padStart(2, '0');
    const minutes = String(bdTime.getMinutes()).padStart(2, '0');
    return {
        date: `${year}-${month}-${day}`,
        time: `${hours}:${minutes}`,
        fullDateTime: `${year}-${month}-${day} ${hours}:${minutes}`,
        timestamp: bdTime.getTime()
    };
}

function getBangladeshDate() {
    const now = new Date();
    return new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Dhaka' }));
}

function updateFloatingNotes() {
    const floatingNotes = document.getElementById('floatingNotes');
    const floatingNotesList = document.getElementById('floatingNotesList');
    
    if (selectedNotes.length === 0) {
        floatingNotes.style.display = 'none';
        return;
    }
    
    floatingNotes.style.display = 'block';
    floatingNotesList.innerHTML = selectedNotes.map(note => `
        <div class="floating-note-item">
            <span class="floating-note-time">ðŸ“… ${note.date} â° ${note.time}</span>
            ${note.content.substring(0, 50)}${note.content.length > 50 ? '...' : ''}
        </div>
    `).join('');
}

function updateSelectedNotesList() {
    const selectedNotesDiv = document.getElementById('selectedNotesList');
    if (!selectedNotesDiv) return;
    
    if (selectedNotes.length === 0) {
        selectedNotesDiv.innerHTML = '';
        return;
    }
    
    selectedNotesDiv.innerHTML = `
        <div class="selected-notes-title">
            <span>ðŸ“Œ</span> à¦¸à¦¿à¦²à§‡à¦•à§à¦Ÿà§‡à¦¡ à¦¨à§‹à¦Ÿ (${selectedNotes.length} à¦Ÿà¦¿)
        </div>
        ${selectedNotes.map(note => `
            <div class="selected-note-item">
                <div class="selected-note-content">
                    <small>ðŸ“… ${note.date} â° ${note.time}</small><br>
                    ${note.content}
                </div>
                <span class="selected-note-remove" onclick="removeSelectedNote('${note.id}')">âœ•</span>
            </div>
        `).join('')}
    `;
    
    updateFloatingNotes();
    localStorage.setItem('selectedNotes', JSON.stringify(selectedNotes));
}

function toggleSelectNote(id) {
    const note = notes.find(n => n.id === id);
    if (!note) return;
    
    const index = selectedNotes.findIndex(n => n.id === id);
    if (index === -1) {
        selectedNotes.push(note);
    } else {
        selectedNotes.splice(index, 1);
    }
    
    updateSelectedNotesList();
    updateNotesList();
}

function removeSelectedNote(id) {
    const index = selectedNotes.findIndex(n => n.id === id);
    if (index !== -1) {
        selectedNotes.splice(index, 1);
        updateSelectedNotesList();
        updateNotesList();
    }
}

function switchTab(tab) {
    document.getElementById('transactionSection').classList.add('hidden');
    document.getElementById('customersSection').classList.add('hidden');
    document.getElementById('cashSection').classList.add('hidden');
    document.getElementById('stockSection').classList.add('hidden');
    document.getElementById('expenseSection').classList.add('hidden');
    document.getElementById('profitSection').classList.add('hidden');
    document.getElementById('noteSection').classList.add('hidden');
    document.getElementById('transactionHeader').classList.add('hidden');
    document.getElementById('cashHeader').classList.add('hidden');
    document.getElementById('transactionTab').classList.remove('active');
    document.getElementById('customersTab').classList.remove('active');
    document.getElementById('cashTab').classList.remove('active');
    document.getElementById('stockTab').classList.remove('active');
    document.getElementById('expenseTab').classList.remove('active');
    document.getElementById('profitTab').classList.remove('active');
    document.getElementById('noteTab').classList.remove('active');
    
    if (tab === 'transaction') {
        document.getElementById('transactionSection').classList.remove('hidden');
        document.getElementById('transactionHeader').classList.remove('hidden');
        document.getElementById('transactionTab').classList.add('active');
        updateTransactionBalance();
        updateTransactionsList();
    } else if (tab === 'customers') {
        document.getElementById('customersSection').classList.remove('hidden');
        document.getElementById('customersTab').classList.add('active');
        updateCustomerList();
        updateSummary();
        updateCustomerTabBalance();
    } else if (tab === 'cash') {
        document.getElementById('cashSection').classList.remove('hidden');
        document.getElementById('cashHeader').classList.remove('hidden');
        document.getElementById('cashTab').classList.add('active');
        initializeCashTab();
    } else if (tab === 'stock') {
        document.getElementById('stockSection').classList.remove('hidden');
        document.getElementById('stockTab').classList.add('active');
        updateProductList();
        updateStockSummary();
        updatePastPurchaseGrid();
        updatePurchaseAverages();
    } else if (tab === 'expense') {
        document.getElementById('expenseSection').classList.remove('hidden');
        document.getElementById('expenseTab').classList.add('active');
        updateExpenseList();
        updateExpenseSummary();
        updatePastExpenseGrid();
    } else if (tab === 'profit') {
        document.getElementById('profitSection').classList.remove('hidden');
        document.getElementById('profitTab').classList.add('active');
        loadInitialCapital();
        updateProfitLoss();
    } else if (tab === 'note') {
        document.getElementById('noteSection').classList.remove('hidden');
        document.getElementById('noteTab').classList.add('active');
        updateNotesList();
        updateSelectedNotesList();
    }
}

function init() {
    const today = getBangladeshDateForInput();
    
    document.getElementById('fromDate').value = today;
    document.getElementById('toDate').value = today;
    document.getElementById('cashDate').value = today;
    document.getElementById('cashFromDate').value = today;
    document.getElementById('cashToDate').value = today;
    document.getElementById('stockFromDate').value = today;
    document.getElementById('stockToDate').value = today;
    document.getElementById('expenseFromDate').value = today;
    document.getElementById('expenseToDate').value = today;
    document.getElementById('expenseDate').value = today;
    document.getElementById('productDate').value = today;
    document.getElementById('transFromDate').value = today;
    document.getElementById('transToDate').value = today;
    document.getElementById('capitalDate').value = today;
    document.getElementById('profitFromDate').value = today;
    document.getElementById('profitToDate').value = today;
    document.getElementById('noteFromDate').value = today;
    document.getElementById('noteToDate').value = today;
    
    updateCustomerList();
    updateTransactionsList();
    updateTransactionBalance();
    updateSummary();
    updateCustomerTabBalance();
    initializeCashTab();
    updateProductList();
    updateStockSummary();
    updatePastPurchaseGrid();
    updatePurchaseAverages();
    updateTotalStockValue();
    updateExpenseList();
    updateExpenseSummary();
    updatePastExpenseGrid();
    loadInitialCapital();
    updateProfitLoss();
    updateNotesList();
    updateSelectedNotesList();
    updateFloatingNotes();
}

function setType(type) {
    transactionType = type;
    document.getElementById('incBtn').classList.remove('active');
    document.getElementById('expBtn').classList.remove('active');
    document.getElementById(type + 'Btn').classList.add('active');
}

function showList() {
    if (customers.length > 0) {
        document.getElementById('custList').classList.add('show');
    }
}

function filterCust() {
    if (customers.length > 0) {
        document.getElementById('custList').classList.add('show');
        updateCustomerDropdown();
    }
}

function updateCustomerDropdown() {
    const search = document.getElementById('srcCust').value.toLowerCase();
    let filtered = customers;
    
    if (search) {
        filtered = customers.filter(c => 
            c.name.toLowerCase().includes(search) || 
            (c.phone && c.phone.includes(search))
        );
    }
    
    const list = document.getElementById('custList');
    list.innerHTML = '';
    
    if (filtered.length === 0) {
        list.innerHTML = '<div class="cust-item" style="justify-content:center;">à¦•à§‹à¦¨ à¦—à§à¦°à¦¾à¦¹à¦• à¦¨à§‡à¦‡</div>';
        return;
    }
    
    filtered.forEach(c => {
        const div = document.createElement('div');
        div.className = `cust-item ${selectedCustomer && selectedCustomer.id === c.id ? 'selected' : ''}`;
        div.onclick = () => selectCustomer(c);
        div.innerHTML = `
            <div class="cust-avatar">${c.name.charAt(0)}</div>
            <div class="cust-info">
                <div class="cust-name">${c.name}</div>
                <div class="cust-phone">ðŸ“ž ${c.phone || 'à¦«à§‹à¦¨ à¦¨à§‡à¦‡'}</div>
            </div>
        `;
        list.appendChild(div);
    });
}

function selectCustomer(customer) {
    selectedCustomer = customer;
    document.getElementById('srcCust').value = customer.name;
    document.getElementById('selCustId').value = customer.id;
    
    document.getElementById('selectedCustInfo').style.display = 'block';
    document.getElementById('selectedCustName').textContent = customer.name;
    document.getElementById('selectedCustPhone').textContent = customer.phone || 'à¦«à§‹à¦¨ à¦¨à§‡à¦‡';
    document.getElementById('custInitial').textContent = customer.name.charAt(0);
    
    document.getElementById('custList').classList.remove('show');
}

function openNewCustomerModal() {
    document.getElementById('newCustomerModal').classList.add('show');
}

function closeNewCustomerModal() {
    document.getElementById('newCustomerModal').classList.remove('show');
    document.getElementById('newCustName').value = '';
    document.getElementById('newCustPhone').value = '';
    document.getElementById('newCustAddr').value = '';
}

function saveNewCustomer(e) {
    e.preventDefault();
    
    const customer = {
        id: Date.now().toString(),
        name: document.getElementById('newCustName').value,
        phone: document.getElementById('newCustPhone').value,
        addr: document.getElementById('newCustAddr').value
    };
    
    customers.push(customer);
    localStorage.setItem('customers', JSON.stringify(customers));
    
    closeNewCustomerModal();
    updateCustomerDropdown();
    selectCustomer(customer);
    updateCustomerList();
    updateSummary();
    updateCustomerTabBalance();
    
    pendingSync = true;
    if (isOnline && !isSyncing) {
        autoSync();
    }
}

function saveTransaction(e) {
    e.preventDefault();
    
    if (!selectedCustomer) {
        alert('à¦—à§à¦°à¦¾à¦¹à¦• à¦¨à¦¿à¦°à§à¦¬à¦¾à¦šà¦¨ à¦•à¦°à§à¦¨');
        return;
    }
    
    const amount = parseFloat(document.getElementById('amt').value);
    if (amount <= 0) {
        alert('à¦ªà¦°à¦¿à¦®à¦¾à¦£ à§¦ à¦à¦° à¦¬à§‡à¦¶à¦¿ à¦¹à¦¤à§‡ à¦¹à¦¬à§‡');
        return;
    }
    
    const now = new Date();
    const bdTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Dhaka' }));
    
    const dateStr = bdTime.toLocaleDateString('bn-BD');
    const timeStr = bdTime.toLocaleTimeString('bn-BD', { hour: '2-digit', minute: '2-digit' });
    
    const transaction = {
        id: editingId || Date.now().toString(),
        type: transactionType,
        custId: selectedCustomer.id,
        custName: selectedCustomer.name,
        desc: document.getElementById('desc').value,
        amount: amount,
        date: dateStr,
        time: timeStr,
        timestamp: bdTime.getTime(),
        fullDate: bdTime.toISOString()
    };
    
    if (editingId) {
        const index = transactions.findIndex(t => t.id === editingId);
        if (index !== -1) transactions[index] = transaction;
        editingId = null;
        document.getElementById('svBtn').innerHTML = '<span>âœ”</span> à¦²à§‡à¦¨à¦¦à§‡à¦¨ à¦¸à¦‚à¦°à¦•à§à¦·à¦£';
    } else {
        transactions.push(transaction);
    }
    
    transactions.sort((a, b) => b.timestamp - a.timestamp);
    localStorage.setItem('transactions', JSON.stringify(transactions));
    
    e.target.reset();
    document.getElementById('srcCust').value = '';
    document.getElementById('selectedCustInfo').style.display = 'none';
    selectedCustomer = null;
    
    updateTransactionsList();
    updateTransactionBalance();
    updateCustomerList();
    updateSummary();
    updateCustomerTabBalance();
    updateTotalStockValue();
    updateProfitLoss();
    
    pendingSync = true;
    if (isOnline && !isSyncing) {
        autoSync();
    }
}

function editTransaction(id) {
    const t = transactions.find(t => t.id === id);
    if (!t) return;
    
    editingId = id;
    setType(t.type);
    
    const customer = customers.find(c => c.id === t.custId);
    if (customer) selectCustomer(customer);
    
    document.getElementById('desc').value = t.desc;
    document.getElementById('amt').value = t.amount;
    document.getElementById('svBtn').innerHTML = '<span>âœ</span> à¦²à§‡à¦¨à¦¦à§‡à¦¨ à¦†à¦ªà¦¡à§‡à¦Ÿ';
    
    switchTab('transaction');
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function deleteTransaction(id) {
    if (!confirm('à¦²à§‡à¦¨à¦¦à§‡à¦¨ à¦®à§à¦›à§‡ à¦«à§‡à¦²à¦¬à§‡à¦¨?')) return;
    
    transactions = transactions.filter(t => t.id !== id);
    localStorage.setItem('transactions', JSON.stringify(transactions));
    
    updateTransactionsList();
    updateTransactionBalance();
    updateCustomerList();
    updateSummary();
    updateCustomerTabBalance();
    
    if (currentCustomer) {
        showCustomerDetail(currentCustomer.id);
    }
    
    updateTotalStockValue();
    updateProfitLoss();
    
    pendingSync = true;
    if (isOnline && !isSyncing) {
        autoSync();
    }
}

function calculateTransactionBalance() {
    const sorted = [...transactions].sort((a, b) => a.timestamp - b.timestamp);
    let balance = 0;
    return sorted.map(t => {
        balance += t.type === 'inc' ? t.amount : -t.amount;
        return { ...t, runningBalance: balance };
    }).reverse();
}

function updateTransactionBalance() {
    const withBalance = calculateTransactionBalance();
    const current = withBalance.length > 0 ? withBalance[0].runningBalance : 0;
    const el = document.getElementById('bal');
    el.textContent = (current >= 0 ? '+' : '') + current.toFixed(2);
    el.style.color = current >= 0 ? '#2ecc71' : '#e74c3c';
}

function filterTransactionByType(type) {
    transactionTypeFilter = type;
    
    document.getElementById('transFilterAll').classList.remove('active');
    document.getElementById('transFilterInc').classList.remove('active');
    document.getElementById('transFilterExp').classList.remove('active');
    
    document.getElementById(`transFilter${type === 'all' ? 'All' : (type === 'inc' ? 'Inc' : 'Exp')}`).classList.add('active');
    
    updateTransactionsList();
}

function applyTransactionDateFilter() {
    transactionDateFilter.from = document.getElementById('transFromDate').value;
    transactionDateFilter.to = document.getElementById('transToDate').value;
    updateTransactionsList();
}

function resetTransactionDateFilter() {
    const today = getBangladeshDateForInput();
    document.getElementById('transFromDate').value = today;
    document.getElementById('transToDate').value = today;
    transactionDateFilter = { from: '', to: '' };
    updateTransactionsList();
}

function filterTransactions() {
    transactionSearchTerm = document.getElementById('transactionSearch').value.toLowerCase();
    updateTransactionsList();
}

function getFilteredTransactions() {
    let filtered = transactions;
    
    if (transactionTypeFilter !== 'all') {
        filtered = filtered.filter(t => t.type === transactionTypeFilter);
    }
    
    if (transactionDateFilter.from && transactionDateFilter.to) {
        const fromDate = new Date(transactionDateFilter.from + 'T00:00:00+06:00');
        const toDate = new Date(transactionDateFilter.to + 'T23:59:59+06:00');
        
        filtered = filtered.filter(t => {
            const tDate = new Date(t.fullDate);
            return tDate >= fromDate && tDate <= toDate;
        });
    }
    
    if (transactionSearchTerm) {
        filtered = filtered.filter(t => 
            t.custName.toLowerCase().includes(transactionSearchTerm) || 
            t.desc.toLowerCase().includes(transactionSearchTerm)
        );
    }
    
    return filtered.sort((a, b) => b.timestamp - a.timestamp);
}

function updateTransactionsList() {
    const filtered = getFilteredTransactions();
    const withBalance = calculateTransactionBalance().filter(t => filtered.some(f => f.id === t.id));
    
    const list = document.getElementById('transactionsList');
    
    if (withBalance.length === 0) {
        list.innerHTML = '<div class="info-msg">à¦•à§‹à¦¨ à¦²à§‡à¦¨à¦¦à§‡à¦¨ à¦¨à§‡à¦‡</div>';
        return;
    }
    
    list.innerHTML = withBalance.map(t => `
        <div class="transaction-item">
            <div class="trans-header">
                <span class="type-badge ${t.type === 'inc' ? 'type-inc' : 'type-exp'}">
                    ${t.type === 'inc' ? 'âž• à¦¦à¦¿à¦²à¦¾à¦®' : 'âž– à¦ªà§‡à¦²à¦¾à¦®'}
                </span>
                <span class="amount ${t.type === 'inc' ? 'positive' : 'negative'}">
                    ${t.type === 'inc' ? '+' : '-'}${t.amount.toFixed(2)}
                </span>
            </div>
            <div class="trans-details">
                <div>ðŸ‘¤ ${t.custName}</div>
                <div>ðŸ“ ${t.desc}</div>
            </div>
            <div class="trans-meta">
                <span>ðŸ“… ${t.date} â° ${t.time}</span>
                <span class="${t.runningBalance >= 0 ? 'positive' : 'negative'}">
                    à¦¬à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¸: ${t.runningBalance >= 0 ? '+' : ''}${t.runningBalance.toFixed(2)}
                </span>
            </div>
            <div class="trans-actions">
                <button onclick="editTransaction('${t.id}')" style="background:#f39c12; color:#fff;">à¦à¦¡à¦¿à¦Ÿ</button>
                <button onclick="deleteTransaction('${t.id}')" style="background:#e74c3c; color:#fff;">à¦¡à¦¿à¦²à¦¿à¦Ÿ</button>
            </div>
        </div>
    `).join('');
}

function exportTransactionsToExcel() {
    const filtered = getFilteredTransactions();
    const data = filtered.map(t => ({
        'à¦¤à¦¾à¦°à¦¿à¦–': t.date,
        'à¦¸à¦®à¦¯à¦¼': t.time,
        'à¦Ÿà¦¾à¦‡à¦ª': t.type === 'inc' ? 'à¦¦à¦¿à¦²à¦¾à¦®' : 'à¦ªà§‡à¦²à¦¾à¦®',
        'à¦—à§à¦°à¦¾à¦¹à¦•': t.custName,
        'à¦¬à¦¿à¦¬à¦°à¦£': t.desc,
        'à¦ªà¦°à¦¿à¦®à¦¾à¦£': t.amount.toFixed(2)
    }));
    
    exportToCSV(data, 'à¦²à§‡à¦¨à¦¦à§‡à¦¨');
}

function exportTransactionsToTxt() {
    const filtered = getFilteredTransactions();
    
    let text = companyHeader;
    text += 'à¦²à§‡à¦¨à¦¦à§‡à¦¨ à¦¬à¦¿à¦¬à¦°à¦£\n';
    text += '==================\n\n';
    
    let totalGiven = 0;
    let totalTaken = 0;
    
    filtered.forEach(t => {
        text += `à¦¤à¦¾à¦°à¦¿à¦–: ${t.date} ${t.time}\n`;
        text += `à¦Ÿà¦¾à¦‡à¦ª: ${t.type === 'inc' ? 'à¦¦à¦¿à¦²à¦¾à¦®' : 'à¦ªà§‡à¦²à¦¾à¦®'}\n`;
        text += `à¦—à§à¦°à¦¾à¦¹à¦•: ${t.custName}\n`;
        text += `à¦¬à¦¿à¦¬à¦°à¦£: ${t.desc}\n`;
        text += `à¦ªà¦°à¦¿à¦®à¦¾à¦£: ${t.type === 'inc' ? '+' : '-'}${t.amount.toFixed(2)}\n`;
        text += '------------------\n';
        
        if (t.type === 'inc') totalGiven += t.amount;
        else totalTaken += t.amount;
    });
    
    const balance = totalGiven - totalTaken;
    
    text += '\nà¦¸à¦¾à¦°à¦¸à¦‚à¦•à§à¦·à§‡à¦ª\n';
    text += '==================\n';
    text += `à¦®à§‹à¦Ÿ à¦¦à¦¿à¦²à¦¾à¦®: +${totalGiven.toFixed(2)}\n`;
    text += `à¦®à§‹à¦Ÿ à¦ªà§‡à¦²à¦¾à¦®: -${totalTaken.toFixed(2)}\n`;
    text += `à¦¬à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¸: ${balance >= 0 ? '+' : ''}${balance.toFixed(2)}\n`;
    text += `à¦®à§‹à¦Ÿ à¦²à§‡à¦¨à¦¦à§‡à¦¨: ${filtered.length} à¦Ÿà¦¿\n`;
    
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `à¦²à§‡à¦¨à¦¦à§‡à¦¨_${getBangladeshDateForInput()}.txt`;
    a.click();
}

function filterCustomers() {
    updateCustomerList();
    updateCustomerTabBalance();
}

function filterByBalance(type) {
    currentFilter = type;
    
    document.getElementById('filterAll').classList.remove('active');
    document.getElementById('filterPositive').classList.remove('active');
    document.getElementById('filterNegative').classList.remove('active');
    document.getElementById('filterZero').classList.remove('active');
    
    document.getElementById(`filter${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('active');
    
    updateCustomerList();
    updateCustomerTabBalance();
}

function applyDateFilter() {
    currentDateFilter.from = document.getElementById('fromDate').value;
    currentDateFilter.to = document.getElementById('toDate').value;
    updateCustomerList();
    updateSummary();
    updateCustomerTabBalance();
}

function resetDateFilter() {
    const today = getBangladeshDateForInput();
    document.getElementById('fromDate').value = today;
    document.getElementById('toDate').value = today;
    currentDateFilter = { from: '', to: '' };
    updateCustomerList();
    updateSummary();
    updateCustomerTabBalance();
}

function calculateCustomerStats(customerId, dateFilter = null) {
    let customerTransactions = transactions.filter(t => t.custId === customerId);
    
    if (dateFilter && dateFilter.from && dateFilter.to) {
        const fromDate = new Date(dateFilter.from + 'T00:00:00+06:00');
        const toDate = new Date(dateFilter.to + 'T23:59:59+06:00');
        
        customerTransactions = customerTransactions.filter(t => {
            const tDate = new Date(t.fullDate);
            return tDate >= fromDate && tDate <= toDate;
        });
    }
    
    let totalGiven = 0;
    let totalTaken = 0;
    
    customerTransactions.forEach(t => {
        if (t.type === 'inc') totalGiven += t.amount;
        else totalTaken += t.amount;
    });
    
    const balance = totalGiven - totalTaken;
    
    return { totalGiven, totalTaken, balance, transactionCount: customerTransactions.length, transactions: customerTransactions };
}

function updateSummary() {
    let totalGiven = 0;
    let totalTaken = 0;
    
    customers.forEach(customer => {
        const stats = calculateCustomerStats(customer.id, currentDateFilter);
        totalGiven += stats.totalGiven;
        totalTaken += stats.totalTaken;
    });
    
    document.getElementById('totalCustomers').textContent = customers.length;
    document.getElementById('totalGiven').textContent = totalGiven.toFixed(2);
    document.getElementById('totalTaken').textContent = totalTaken.toFixed(2);
}

function updateCustomerList() {
    const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
    let filteredCustomers = customers;
    
    if (searchTerm) {
        filteredCustomers = filteredCustomers.filter(c => 
            c.name.toLowerCase().includes(searchTerm) || 
            (c.phone && c.phone.includes(searchTerm))
        );
    }
    
    if (currentFilter !== 'all') {
        filteredCustomers = filteredCustomers.filter(c => {
            const stats = calculateCustomerStats(c.id, currentDateFilter);
            if (currentFilter === 'positive') return stats.balance > 0;
            if (currentFilter === 'negative') return stats.balance < 0;
            if (currentFilter === 'zero') return stats.balance === 0;
            return true;
        });
    }
    
    const list = document.getElementById('customerList');
    
    if (filteredCustomers.length === 0) {
        list.innerHTML = '<div class="info-msg">à¦•à§‹à¦¨ à¦—à§à¦°à¦¾à¦¹à¦• à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿</div>';
        return;
    }
    
    list.innerHTML = filteredCustomers.map(customer => {
        const stats = calculateCustomerStats(customer.id, currentDateFilter);
        const initial = customer.name.charAt(0);
        
        return `
            <div class="customer-card" onclick="showCustomerDetail('${customer.id}')">
                <div class="customer-header">
                    <div class="customer-name">
                        <div class="avatar">${initial}</div>
                        <div class="name">
                            <h4>${customer.name}</h4>
                            <p>ðŸ“ž ${customer.phone || 'à¦«à§‹à¦¨ à¦¨à§‡à¦‡'}</p>
                        </div>
                    </div>
                    <span class="balance-badge ${stats.balance >= 0 ? 'positive' : 'negative'}">
                        ${stats.balance >= 0 ? '+' : ''}${stats.balance.toFixed(2)}
                    </span>
                </div>
                <div class="customer-stats">
                    <div class="stat">
                        <div class="stat-label">à¦¦à¦¿à¦²à¦¾à¦®</div>
                        <div class="stat-value positive">+${stats.totalGiven.toFixed(2)}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">à¦ªà§‡à¦²à¦¾à¦®</div>
                        <div class="stat-value negative">-${stats.totalTaken.toFixed(2)}</div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function showCustomerDetail(customerId) {
    const customer = customers.find(c => c.id === customerId);
    if (!customer) return;
    
    currentCustomer = customer;
    
    const fromDate = document.getElementById('modalFromDate')?.value || getBangladeshDateForInput();
    const toDate = document.getElementById('modalToDate')?.value || getBangladeshDateForInput();
    const dateFilter = { from: fromDate, to: toDate };
    const stats = calculateCustomerStats(customerId, dateFilter);
    
    const content = `
        <div class="detail-header">
            <div class="detail-info">
                <div class="detail-avatar">${customer.name.charAt(0)}</div>
                <div class="detail-contact">
                    <h4>${customer.name}</h4>
                    <p>ðŸ“ž ${customer.phone || 'à¦«à§‹à¦¨ à¦¨à§‡à¦‡'}</p>
                    <p>ðŸ“ ${customer.addr || 'à¦ à¦¿à¦•à¦¾à¦¨à¦¾ à¦¨à§‡à¦‡'}</p>
                </div>
            </div>
            
            <div class="customer-summary-stats">
                <div class="stat-card">
                    <div class="label">à¦¦à¦¿à¦²à¦¾à¦®</div>
                    <div class="value positive">+${stats.totalGiven.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="label">à¦ªà§‡à¦²à¦¾à¦®</div>
                    <div class="value negative">-${stats.totalTaken.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="label">à¦¬à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¸</div>
                    <div class="value ${stats.balance >= 0 ? 'positive' : 'negative'}">
                        ${stats.balance >= 0 ? '+' : ''}${stats.balance.toFixed(2)}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal-filter">
            <div class="modal-date-filter">
                <input type="date" id="modalFromDate" value="${fromDate}">
                <input type="date" id="modalToDate" value="${toDate}">
            </div>
            <div class="filter-actions" style="margin-bottom:10px;">
                <button class="filter-btn apply-btn" onclick="applyModalDateFilter('${customerId}')">à¦«à¦¿à¦²à§à¦Ÿà¦¾à¦°</button>
                <button class="filter-btn reset-btn" onclick="resetModalDateFilter('${customerId}')">à¦°à¦¿à¦¸à§‡à¦Ÿ</button>
            </div>
            <div class="modal-export">
                <button class="export-btn excel-btn" onclick="exportCustomerToExcel('${customerId}')">ðŸ“Š Excel</button>
                <button class="export-btn txt-btn" onclick="exportCustomerToTxt('${customerId}')">ðŸ“ TXT</button>
            </div>
        </div>
        
        <div id="customerTransactionsList"></div>
        
        <div style="display:flex; gap:8px; margin-top:20px;">
            <button onclick="editCustomer()" style="flex:2; padding:14px; background:#f39c12; color:#fff; border:none; border-radius:20px; font-weight:600;">âœ à¦—à§à¦°à¦¾à¦¹à¦• à¦à¦¡à¦¿à¦Ÿ</button>
            <button onclick="deleteCustomer()" style="flex:1; padding:14px; background:#e74c3c; color:#fff; border:none; border-radius:20px; font-weight:600;">ðŸ—‘ à¦¡à¦¿à¦²à¦¿à¦Ÿ</button>
        </div>
    `;
    
    document.getElementById('customerDetailContent').innerHTML = content;
    document.getElementById('customerDetailModal').classList.add('show');
    document.getElementById('detailModalTitle').textContent = `${customer.name} - à¦²à§‡à¦¨à¦¦à§‡à¦¨`;
    
    updateCustomerTransactionsList(customerId);
}

function updateCustomerTransactionsList(customerId) {
    const fromDate = document.getElementById('modalFromDate')?.value;
    const toDate = document.getElementById('modalToDate')?.value;
    
    const dateFilter = (fromDate && toDate) ? { from: fromDate, to: toDate } : null;
    const transactionsWithBalance = calculateCustomerBalance(customerId, dateFilter).reverse();
    
    if (fromDate && toDate) {
        const stats = calculateCustomerStats(customerId, { from: fromDate, to: toDate });
        updateModalStats(stats);
    }
    
    const list = document.getElementById('customerTransactionsList');
    
    if (transactionsWithBalance.length === 0) {
        list.innerHTML = '<p style="text-align:center; padding:20px; color:#718096;">à¦•à§‹à¦¨ à¦²à§‡à¦¨à¦¦à§‡à¦¨ à¦¨à§‡à¦‡</p>';
        return;
    }
    
    list.innerHTML = transactionsWithBalance.map(t => `
        <div class="trans-item">
            <div class="trans-header">
                <span class="trans-type ${t.type === 'inc' ? 'inc-badge' : 'exp-badge'}">
                    ${t.type === 'inc' ? 'à¦¦à¦¿à¦²à¦¾à¦®' : 'à¦ªà§‡à¦²à¦¾à¦®'}
                </span>
                <span class="trans-amount ${t.type === 'inc' ? 'positive' : 'negative'}">
                    ${t.type === 'inc' ? '+' : '-'}${t.amount.toFixed(2)}
                </span>
            </div>
            <div class="trans-desc">${t.desc}</div>
            <div class="trans-time">ðŸ“… ${t.date} â° ${t.time}</div>
            <div class="trans-balance ${t.runningBalance >= 0 ? 'positive' : 'negative'}">
                à¦¬à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¸: ${t.runningBalance >= 0 ? '+' : ''}${t.runningBalance.toFixed(2)}
            </div>
            <div class="trans-actions">
                <button onclick="editTransaction('${t.id}')" style="background:#f39c12; color:#fff;">à¦à¦¡à¦¿à¦Ÿ</button>
                <button onclick="deleteTransaction('${t.id}')" style="background:#e74c3c; color:#fff;">à¦¡à¦¿à¦²à¦¿à¦Ÿ</button>
            </div>
        </div>
    `).join('');
}

function updateModalStats(stats) {
    const statCards = document.querySelectorAll('.customer-summary-stats .stat-card');
    if (statCards.length >= 3) {
        statCards[0].querySelector('.value').textContent = `+${stats.totalGiven.toFixed(2)}`;
        statCards[1].querySelector('.value').textContent = `-${stats.totalTaken.toFixed(2)}`;
        const balanceEl = statCards[2].querySelector('.value');
        balanceEl.textContent = `${stats.balance >= 0 ? '+' : ''}${stats.balance.toFixed(2)}`;
        balanceEl.className = `value ${stats.balance >= 0 ? 'positive' : 'negative'}`;
    }
}

function applyModalDateFilter(customerId) {
    updateCustomerTransactionsList(customerId);
}

function resetModalDateFilter(customerId) {
    const today = getBangladeshDateForInput();
    document.getElementById('modalFromDate').value = today;
    document.getElementById('modalToDate').value = today;
    updateCustomerTransactionsList(customerId);
}

function editCustomer() {
    if (!currentCustomer) return;
    
    document.getElementById('newCustName').value = currentCustomer.name;
    document.getElementById('newCustPhone').value = currentCustomer.phone || '';
    document.getElementById('newCustAddr').value = currentCustomer.addr || '';
    
    closeDetailModal();
    openNewCustomerModal();
    
    const form = document.querySelector('#newCustomerModal form');
    form.onsubmit = (e) => {
        e.preventDefault();
        
        currentCustomer.name = document.getElementById('newCustName').value;
        currentCustomer.phone = document.getElementById('newCustPhone').value;
        currentCustomer.addr = document.getElementById('newCustAddr').value;
        
        const index = customers.findIndex(c => c.id === currentCustomer.id);
        if (index !== -1) customers[index] = currentCustomer;
        
        transactions = transactions.map(t => {
            if (t.custId === currentCustomer.id) {
                t.custName = currentCustomer.name;
            }
            return t;
        });
        
        localStorage.setItem('customers', JSON.stringify(customers));
        localStorage.setItem('transactions', JSON.stringify(transactions));
        
        closeNewCustomerModal();
        updateCustomerList();
        updateSummary();
        updateTransactionsList();
        updateCustomerTabBalance();
        
        alert('à¦—à§à¦°à¦¾à¦¹à¦• à¦†à¦ªà¦¡à§‡à¦Ÿ à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡');
        
        pendingSync = true;
        if (isOnline && !isSyncing) {
            autoSync();
        }
    };
}

function deleteCustomer() {
    if (!currentCustomer) return;
    
    if (confirm(`${currentCustomer.name} à¦•à§‡ à¦®à§à¦›à§‡ à¦«à§‡à¦²à¦¬à§‡à¦¨? à¦¤à¦¾à¦° à¦¸à¦•à¦² à¦²à§‡à¦¨à¦¦à§‡à¦¨à¦“ à¦®à§à¦›à§‡ à¦¯à¦¾à¦¬à§‡!`)) {
        transactions = transactions.filter(t => t.custId !== currentCustomer.id);
        customers = customers.filter(c => c.id !== currentCustomer.id);
        
        localStorage.setItem('transactions', JSON.stringify(transactions));
        localStorage.setItem('customers', JSON.stringify(customers));
        
        closeDetailModal();
        updateCustomerList();
        updateSummary();
        updateTransactionsList();
        updateTransactionBalance();
        updateCustomerTabBalance();
        
        alert('à¦—à§à¦°à¦¾à¦¹à¦• à¦“ à¦¤à¦¾à¦° à¦²à§‡à¦¨à¦¦à§‡à¦¨ à¦®à§à¦›à§‡ à¦«à§‡à¦²à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡');
        
        pendingSync = true;
        if (isOnline && !isSyncing) {
            autoSync();
        }
    }
}

function calculateCustomerBalance(customerId, dateFilter = null) {
    let customerTransactions = transactions.filter(t => t.custId === customerId)
        .sort((a, b) => a.timestamp - b.timestamp);
    
    if (dateFilter && dateFilter.from && dateFilter.to) {
        const fromDate = new Date(dateFilter.from + 'T00:00:00+06:00');
        const toDate = new Date(dateFilter.to + 'T23:59:59+06:00');
        
        customerTransactions = customerTransactions.filter(t => {
            const tDate = new Date(t.fullDate);
            return tDate >= fromDate && tDate <= toDate;
        });
    }
    
    let balance = 0;
    return customerTransactions.map(t => {
        balance += t.type === 'inc' ? t.amount : -t.amount;
        return { ...t, runningBalance: balance };
    });
}

function updateCustomerTabBalance() {
    let totalGiven = 0;
    let totalTaken = 0;
    
    customers.forEach(customer => {
        const stats = calculateCustomerStats(customer.id, currentDateFilter);
        totalGiven += stats.totalGiven;
        totalTaken += stats.totalTaken;
    });
    
    const balance = totalGiven - totalTaken;
    const el = document.getElementById('customerTabBalance');
    el.textContent = (balance >= 0 ? '+' : '') + balance.toFixed(2);
    el.style.color = balance >= 0 ? '#2ecc71' : '#e74c3c';
}

function calculateCashTotal() {
    const note1000 = parseInt(document.getElementById('note1000').value) || 0;
    const note500 = parseInt(document.getElementById('note500').value) || 0;
    const note200 = parseInt(document.getElementById('note200').value) || 0;
    const note100 = parseInt(document.getElementById('note100').value) || 0;
    const note50 = parseInt(document.getElementById('note50').value) || 0;
    const note20 = parseInt(document.getElementById('note20').value) || 0;
    const note10 = parseInt(document.getElementById('note10').value) || 0;
    const note5 = parseInt(document.getElementById('note5').value) || 0;
    const note2 = parseInt(document.getElementById('note2').value) || 0;
    const note1 = parseInt(document.getElementById('note1').value) || 0;
    const coin50 = parseFloat(document.getElementById('coin50').value) || 0;
    const coin25 = parseFloat(document.getElementById('coin25').value) || 0;
    
    const total = (note1000 * 1000) + (note500 * 500) + (note200 * 200) + (note100 * 100) +
                  (note50 * 50) + (note20 * 20) + (note10 * 10) + (note5 * 5) +
                  (note2 * 2) + (note1 * 1) + (coin50 * 0.50) + (coin25 * 0.25);
    
    document.getElementById('cashTotalDisplay').textContent = total.toFixed(2) + ' à§³';
    return total;
}

function saveCashData() {
    const date = document.getElementById('cashDate').value;
    const total = calculateCashTotal();
    
    const notes = {
        note1000: parseInt(document.getElementById('note1000').value) || 0,
        note500: parseInt(document.getElementById('note500').value) || 0,
        note200: parseInt(document.getElementById('note200').value) || 0,
        note100: parseInt(document.getElementById('note100').value) || 0,
        note50: parseInt(document.getElementById('note50').value) || 0,
        note20: parseInt(document.getElementById('note20').value) || 0,
        note10: parseInt(document.getElementById('note10').value) || 0,
        note5: parseInt(document.getElementById('note5').value) || 0,
        note2: parseInt(document.getElementById('note2').value) || 0,
        note1: parseInt(document.getElementById('note1').value) || 0,
        coin50: parseFloat(document.getElementById('coin50').value) || 0,
        coin25: parseFloat(document.getElementById('coin25').value) || 0
    };
    
    const existingIndex = cashData.findIndex(c => c.date === date);
    const cashEntry = {
        date: date,
        total: total,
        notes: notes,
        timestamp: new Date(date + 'T00:00:00+06:00').getTime()
    };
    
    if (existingIndex !== -1) {
        cashData[existingIndex] = cashEntry;
    } else {
        cashData.push(cashEntry);
    }
    
    cashData.sort((a, b) => b.timestamp - a.timestamp);
    localStorage.setItem('cashData', JSON.stringify(cashData));
    
    const now = new Date();
    const bdTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Dhaka' }));
    
    const dateStr = bdTime.toLocaleDateString('bn-BD');
    const timeStr = bdTime.toLocaleTimeString('bn-BD', { hour: '2-digit', minute: '2-digit' });
    
    const transaction = {
        id: Date.now().toString() + '-cash',
        type: 'inc',
        custId: 'cash-system',
        custName: 'à¦•à§à¦¯à¦¾à¦¶à§‡ à¦¬à¦¿à¦•à§à¦°à§Ÿ',
        desc: `${date} à¦¤à¦¾à¦°à¦¿à¦–à§‡à¦° à¦•à§à¦¯à¦¾à¦¶ à¦¬à¦¿à¦•à§à¦°à§Ÿ`,
        amount: total,
        date: dateStr,
        time: timeStr,
        timestamp: bdTime.getTime(),
        fullDate: bdTime.toISOString()
    };
    
    transactions.push(transaction);
    transactions.sort((a, b) => b.timestamp - a.timestamp);
    localStorage.setItem('transactions', JSON.stringify(transactions));
    
    alert('à¦•à§à¦¯à¦¾à¦¶ à¦¡à¦¾à¦Ÿà¦¾ à¦¸à¦‚à¦°à¦•à§à¦·à¦£ à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡ à¦à¦¬à¦‚ à¦²à§‡à¦¨à¦¦à§‡à¦¨à§‡ à¦¯à§‹à¦— à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡');
    
    updatePastCashGrid();
    updateCashAverages();
    updateTransactionBalance();
    updateTransactionsList();
    updateTotalStockValue();
    updateProfitLoss();
    
    pendingSync = true;
    if (isOnline && !isSyncing) {
        autoSync();
    }
}

function applyCashDateFilter() {
    cashDateFilter.from = document.getElementById('cashFromDate').value;
    cashDateFilter.to = document.getElementById('cashToDate').value;
    
    if (!cashDateFilter.from || !cashDateFilter.to) {
        alert('à¦¤à¦¾à¦°à¦¿à¦– à¦¸à¦¿à¦²à§‡à¦•à§à¦Ÿ à¦•à¦°à§à¦¨');
        return;
    }
    
    const fromDate = new Date(cashDateFilter.from + 'T00:00:00+06:00');
    const toDate = new Date(cashDateFilter.to + 'T23:59:59+06:00');
    
    const filteredCash = cashData.filter(c => {
        const cDate = new Date(c.date + 'T00:00:00+06:00');
        return cDate >= fromDate && cDate <= toDate;
    });
    
    const total = filteredCash.reduce((sum, c) => sum + c.total, 0);
    document.getElementById('filteredCashTotal').textContent = total.toFixed(2) + ' à§³';
}

function resetCashDateFilter() {
    const today = getBangladeshDateForInput();
    document.getElementById('cashFromDate').value = today;
    document.getElementById('cashToDate').value = today;
    cashDateFilter = { from: '', to: '' };
    document.getElementById('filteredCashTotal').textContent = 'à§¦.à§¦à§¦ à§³';
}

function exportCashToExcel() {
    let filteredCash = cashData;
    
    if (cashDateFilter.from && cashDateFilter.to) {
        const fromDate = new Date(cashDateFilter.from + 'T00:00:00+06:00');
        const toDate = new Date(cashDateFilter.to + 'T23:59:59+06:00');
        
        filteredCash = filteredCash.filter(c => {
            const cDate = new Date(c.date + 'T00:00:00+06:00');
            return cDate >= fromDate && cDate <= toDate;
        });
    }
    
    const data = filteredCash.map(c => ({
        'à¦¤à¦¾à¦°à¦¿à¦–': c.date,
        'à§§à§¦à§¦à§¦ à¦Ÿà¦¾à¦•à¦¾': c.notes.note1000,
        'à§«à§¦à§¦ à¦Ÿà¦¾à¦•à¦¾': c.notes.note500,
        'à§¨à§¦à§¦ à¦Ÿà¦¾à¦•à¦¾': c.notes.note200,
        'à§§à§¦à§¦ à¦Ÿà¦¾à¦•à¦¾': c.notes.note100,
        'à§«à§¦ à¦Ÿà¦¾à¦•à¦¾': c.notes.note50,
        'à§¨à§¦ à¦Ÿà¦¾à¦•à¦¾': c.notes.note20,
        'à§§à§¦ à¦Ÿà¦¾à¦•à¦¾': c.notes.note10,
        'à§« à¦Ÿà¦¾à¦•à¦¾': c.notes.note5,
        'à§¨ à¦Ÿà¦¾à¦•à¦¾': c.notes.note2,
        'à§§ à¦Ÿà¦¾à¦•à¦¾': c.notes.note1,
        'à§«à§¦ à¦ªà§Ÿà¦¸à¦¾': c.notes.coin50,
        'à§¨à§« à¦ªà§Ÿà¦¸à¦¾': c.notes.coin25,
        'à¦®à§‹à¦Ÿ à¦ªà¦°à¦¿à¦®à¦¾à¦£': c.total.toFixed(2)
    }));
    
    exportToCSV(data, 'à¦•à§à¦¯à¦¾à¦¶_à¦¬à¦¿à¦¬à¦°à¦£');
}

function exportCashToTxt() {
    let filteredCash = cashData;
    
    if (cashDateFilter.from && cashDateFilter.to) {
        const fromDate = new Date(cashDateFilter.from + 'T00:00:00+06:00');
        const toDate = new Date(cashDateFilter.to + 'T23:59:59+06:00');
        
        filteredCash = filteredCash.filter(c => {
            const cDate = new Date(c.date + 'T00:00:00+06:00');
            return cDate >= fromDate && cDate <= toDate;
        });
    }
    
    let text = companyHeader;
    text += 'à¦•à§à¦¯à¦¾à¦¶ à¦¬à¦¿à¦¬à¦°à¦£\n';
    text += '==================\n\n';
    
    let grandTotal = 0;
    
    filteredCash.forEach(c => {
        text += `à¦¤à¦¾à¦°à¦¿à¦–: ${c.date}\n`;
        text += '------------------\n';
        text += `à§§à§¦à§¦à§¦ à¦Ÿà¦¾à¦•à¦¾: ${c.notes.note1000} à¦Ÿà¦¿ = ${c.notes.note1000 * 1000} à§³\n`;
        text += `à§«à§¦à§¦ à¦Ÿà¦¾à¦•à¦¾: ${c.notes.note500} à¦Ÿà¦¿ = ${c.notes.note500 * 500} à§³\n`;
        text += `à§¨à§¦à§¦ à¦Ÿà¦¾à¦•à¦¾: ${c.notes.note200} à¦Ÿà¦¿ = ${c.notes.note200 * 200} à§³\n`;
        text += `à§§à§¦à§¦ à¦Ÿà¦¾à¦•à¦¾: ${c.notes.note100} à¦Ÿà¦¿ = ${c.notes.note100 * 100} à§³\n`;
        text += `à§«à§¦ à¦Ÿà¦¾à¦•à¦¾: ${c.notes.note50} à¦Ÿà¦¿ = ${c.notes.note50 * 50} à§³\n`;
        text += `à§¨à§¦ à¦Ÿà¦¾à¦•à¦¾: ${c.notes.note20} à¦Ÿà¦¿ = ${c.notes.note20 * 20} à§³\n`;
        text += `à§§à§¦ à¦Ÿà¦¾à¦•à¦¾: ${c.notes.note10} à¦Ÿà¦¿ = ${c.notes.note10 * 10} à§³\n`;
        text += `à§« à¦Ÿà¦¾à¦•à¦¾: ${c.notes.note5} à¦Ÿà¦¿ = ${c.notes.note5 * 5} à§³\n`;
        text += `à§¨ à¦Ÿà¦¾à¦•à¦¾: ${c.notes.note2} à¦Ÿà¦¿ = ${c.notes.note2 * 2} à§³\n`;
        text += `à§§ à¦Ÿà¦¾à¦•à¦¾: ${c.notes.note1} à¦Ÿà¦¿ = ${c.notes.note1 * 1} à§³\n`;
        text += `à§«à§¦ à¦ªà§Ÿà¦¸à¦¾: ${c.notes.coin50} à¦Ÿà¦¿ = ${c.notes.coin50 * 0.50} à§³\n`;
        text += `à§¨à§« à¦ªà§Ÿà¦¸à¦¾: ${c.notes.coin25} à¦Ÿà¦¿ = ${c.notes.coin25 * 0.25} à§³\n`;
        text += `à¦®à§‹à¦Ÿ: ${c.total.toFixed(2)} à§³\n\n`;
        grandTotal += c.total;
    });
    
    text += '==================\n';
    text += `à¦¸à¦°à§à¦¬à¦®à§‹à¦Ÿ (${filteredCash.length} à¦¦à¦¿à¦¨): ${grandTotal.toFixed(2)} à§³\n`;
    
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `à¦•à§à¦¯à¦¾à¦¶_à¦¬à¦¿à¦¬à¦°à¦£_${getBangladeshDateForInput()}.txt`;
    a.click();
}

function updatePastCashGrid() {
    const today = getBangladeshDate();
    const pastDays = [];
    
    for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        const cashEntry = cashData.find(c => c.date === dateStr);
        const dayName = ['à¦°à¦¬à¦¿', 'à¦¸à§‹à¦®', 'à¦®à¦™à§à¦—à¦²', 'à¦¬à§à¦§', 'à¦¬à§ƒà¦¹', 'à¦¶à§à¦•à§à¦°', 'à¦¶à¦¨à¦¿'][date.getDay()];
        
        pastDays.push({
            day: dayName,
            date: dateStr,
            amount: cashEntry ? cashEntry.total : 0
        });
    }
    
    const grid = document.getElementById('pastCashGrid');
    grid.innerHTML = pastDays.map(d => `
        <div class="past-cash-item">
            <div class="past-cash-day">${d.day}</div>
            <div class="past-cash-amount">${d.amount.toFixed(0)}</div>
        </div>
    `).join('');
}

function updateCashAverages() {
    const today = getBangladeshDate();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth();
    
    const thisMonthData = cashData.filter(c => {
        const cDate = new Date(c.date + 'T00:00:00+06:00');
        return cDate.getFullYear() === currentYear && cDate.getMonth() === currentMonth;
    });
    
    const thisMonthTotal = thisMonthData.reduce((sum, c) => sum + c.total, 0);
    const thisMonthAvg = thisMonthData.length > 0 ? thisMonthTotal / thisMonthData.length : 0;
    
    document.getElementById('thisMonthAvg').textContent = thisMonthAvg.toFixed(2);
    document.getElementById('thisMonthDays').textContent = thisMonthData.length + ' à¦¦à¦¿à¦¨';
    
    const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
    const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
    
    const lastMonthData = cashData.filter(c => {
        const cDate = new Date(c.date + 'T00:00:00+06:00');
        return cDate.getFullYear() === lastMonthYear && cDate.getMonth() === lastMonth;
    });
    
    const lastMonthTotal = lastMonthData.reduce((sum, c) => sum + c.total, 0);
    const lastMonthAvg = lastMonthData.length > 0 ? lastMonthTotal / lastMonthData.length : 0;
    
    document.getElementById('lastMonthAvg').textContent = lastMonthAvg.toFixed(2);
    document.getElementById('lastMonthDays').textContent = lastMonthData.length + ' à¦¦à¦¿à¦¨';
}

function initializeCashTab() {
    calculateCashTotal();
    updatePastCashGrid();
    updateCashAverages();
    
    const today = getBangladeshDateForInput();
    const todayCash = cashData.find(c => c.date === today);
    if (todayCash) {
        document.getElementById('note1000').value = todayCash.notes.note1000;
        document.getElementById('note500').value = todayCash.notes.note500;
        document.getElementById('note200').value = todayCash.notes.note200;
        document.getElementById('note100').value = todayCash.notes.note100;
        document.getElementById('note50').value = todayCash.notes.note50;
        document.getElementById('note20').value = todayCash.notes.note20;
        document.getElementById('note10').value = todayCash.notes.note10;
        document.getElementById('note5').value = todayCash.notes.note5;
        document.getElementById('note2').value = todayCash.notes.note2;
        document.getElementById('note1').value = todayCash.notes.note1;
        document.getElementById('coin50').value = todayCash.notes.coin50;
        document.getElementById('coin25').value = todayCash.notes.coin25;
        calculateCashTotal();
    }
}

function searchProductName() {
    const search = document.getElementById('productName').value.toLowerCase();
    const list = document.getElementById('productNameList');
    
    if (!search) {
        list.innerHTML = '';
        return;
    }
    
    const productNames = [...new Set(products.map(p => p.name))];
    const filtered = productNames.filter(name => name.toLowerCase().includes(search));
    
    if (filtered.length === 0) {
        list.innerHTML = '<div class="cust-item" style="justify-content:center;">à¦•à§‹à¦¨ à¦ªà¦£à§à¦¯ à¦¨à§‡à¦‡</div>';
        list.style.display = 'block';
        return;
    }
    
    list.innerHTML = filtered.map(name => `
        <div class="cust-item" onclick="selectProductName('${name}')">
            <div class="cust-avatar">${name.charAt(0)}</div>
            <div class="cust-info">
                <div class="cust-name">${name}</div>
            </div>
        </div>
    `).join('');
    
    list.style.display = 'block';
}

function selectProductName(name) {
    document.getElementById('productName').value = name;
    document.getElementById('productNameList').style.display = 'none';
}

function showProductDropdown() {
    searchProductName();
}

function calculateProfit() {
    const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
    const sellPrice = parseFloat(document.getElementById('sellPrice').value) || 0;
    const qty = parseFloat(document.getElementById('productQty').value) || 0;
    
    const profit = (sellPrice - purchasePrice) * qty;
    document.getElementById('profitAmount').value = profit.toFixed(2);
}

function openNewProductModal() {
    editingProductId = null;
    document.getElementById('productModalTitle').textContent = 'à¦¨à¦¤à§à¦¨ à¦ªà¦£à§à¦¯ à¦•à§à¦°à§Ÿ';
    document.getElementById('saveProductBtn').innerHTML = '<span>âœ”</span> à¦•à§à¦°à§Ÿ à¦¸à¦‚à¦°à¦•à§à¦·à¦£';
    document.getElementById('newProductModal').classList.add('show');
    document.getElementById('productDate').value = getBangladeshDateForInput();
    document.getElementById('productName').value = '';
    document.getElementById('productQty').value = '';
    document.getElementById('productUnit').value = 'à¦•à§‡à¦œà¦¿';
    document.getElementById('productDesc').value = '';
    document.getElementById('purchasePrice').value = '';
    document.getElementById('sellPrice').value = '';
    document.getElementById('profitAmount').value = '';
}

function closeNewProductModal() {
    document.getElementById('newProductModal').classList.remove('show');
}

function saveProduct(e) {
    e.preventDefault();
    
    const date = document.getElementById('productDate').value;
    const name = document.getElementById('productName').value;
    const qty = parseFloat(document.getElementById('productQty').value);
    const unit = document.getElementById('productUnit').value;
    const desc = document.getElementById('productDesc').value;
    const purchasePrice = parseFloat(document.getElementById('purchasePrice').value);
    const sellPrice = parseFloat(document.getElementById('sellPrice').value);
    const totalPurchase = purchasePrice * qty;
    const totalSell = sellPrice * qty;
    const profit = totalSell - totalPurchase;
    
    const product = {
        id: editingProductId || Date.now().toString(),
        date: date,
        name: name,
        qty: qty,
        unit: unit,
        desc: desc,
        purchasePrice: purchasePrice,
        sellPrice: sellPrice,
        totalPurchase: totalPurchase,
        totalSell: totalSell,
        profit: profit,
        timestamp: new Date(date + 'T00:00:00+06:00').getTime()
    };
    
    if (editingProductId) {
        const index = products.findIndex(p => p.id === editingProductId);
        if (index !== -1) products[index] = product;
    } else {
        products.push(product);
    }
    
    products.sort((a, b) => b.timestamp - a.timestamp);
    localStorage.setItem('products', JSON.stringify(products));
    
    closeNewProductModal();
    updateProductList();
    updateStockSummary();
    updatePastPurchaseGrid();
    updatePurchaseAverages();
    updateTotalStockValue();
    updateProfitLoss();
    
    pendingSync = true;
    if (isOnline && !isSyncing) {
        autoSync();
    }
}

function editProduct(id) {
    const product = products.find(p => p.id === id);
    if (!product) return;
    
    editingProductId = id;
    document.getElementById('productModalTitle').textContent = 'à¦ªà¦£à§à¦¯ à¦¸à¦®à§à¦ªà¦¾à¦¦à¦¨à¦¾';
    document.getElementById('saveProductBtn').innerHTML = '<span>âœ”</span> à¦†à¦ªà¦¡à§‡à¦Ÿ';
    document.getElementById('productDate').value = product.date;
    document.getElementById('productName').value = product.name;
    document.getElementById('productQty').value = product.qty;
    document.getElementById('productUnit').value = product.unit;
    document.getElementById('productDesc').value = product.desc || '';
    document.getElementById('purchasePrice').value = product.purchasePrice;
    document.getElementById('sellPrice').value = product.sellPrice;
    calculateProfit();
    
    document.getElementById('newProductModal').classList.add('show');
}

function deleteProduct(id) {
    if (!confirm('à¦à¦‡ à¦ªà¦£à§à¦¯ à¦•à§à¦°à§Ÿ à¦¤à¦¥à§à¦¯ à¦®à§à¦›à§‡ à¦«à§‡à¦²à¦¬à§‡à¦¨?')) return;
    
    products = products.filter(p => p.id !== id);
    localStorage.setItem('products', JSON.stringify(products));
    
    updateProductList();
    updateStockSummary();
    updatePastPurchaseGrid();
    updatePurchaseAverages();
    updateTotalStockValue();
    updateProfitLoss();
    
    pendingSync = true;
    if (isOnline && !isSyncing) {
        autoSync();
    }
}

function filterProducts() {
    stockSearchTerm = document.getElementById('productSearch').value.toLowerCase();
    updateProductList();
}

function applyStockDateFilter() {
    stockDateFilter.from = document.getElementById('stockFromDate').value;
    stockDateFilter.to = document.getElementById('stockToDate').value;
    updateProductList();
    updatePastPurchaseGrid();
    updatePurchaseAverages();
}

function resetStockDateFilter() {
    const today = getBangladeshDateForInput();
    document.getElementById('stockFromDate').value = today;
    document.getElementById('stockToDate').value = today;
    stockDateFilter = { from: '', to: '' };
    updateProductList();
    updatePastPurchaseGrid();
    updatePurchaseAverages();
}

function updateProductList() {
    let filteredProducts = products;
    
    if (stockDateFilter.from && stockDateFilter.to) {
        const fromDate = new Date(stockDateFilter.from + 'T00:00:00+06:00');
        const toDate = new Date(stockDateFilter.to + 'T23:59:59+06:00');
        
        filteredProducts = filteredProducts.filter(p => {
            const pDate = new Date(p.date + 'T00:00:00+06:00');
            return pDate >= fromDate && pDate <= toDate;
        });
    }
    
    if (stockSearchTerm) {
        filteredProducts = filteredProducts.filter(p => 
            p.name.toLowerCase().includes(stockSearchTerm)
        );
    }
    
    const list = document.getElementById('productList');
    
    if (filteredProducts.length === 0) {
        list.innerHTML = '<div class="info-msg">à¦•à§‹à¦¨ à¦ªà¦£à§à¦¯ à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿</div>';
        return;
    }
    
    list.innerHTML = filteredProducts.map(p => `
        <div class="stock-item">
            <div class="stock-header">
                <span class="stock-name">${p.name}</span>
                <span class="stock-qty">${p.qty} ${p.unit}</span>
            </div>
            <div class="stock-details">
                <div class="stock-detail-item">
                    <div class="stock-detail-label">à¦•à§à¦°à§Ÿ à¦®à§‚à¦²à§à¦¯</div>
                    <div class="stock-detail-value">${p.purchasePrice} à§³</div>
                </div>
                <div class="stock-detail-item">
                    <div class="stock-detail-label">à¦¬à¦¿à¦•à§à¦°à§Ÿ à¦®à§‚à¦²à§à¦¯</div>
                    <div class="stock-detail-value">${p.sellPrice} à§³</div>
                </div>
                <div class="stock-detail-item">
                    <div class="stock-detail-label">à¦®à§‹à¦Ÿ à¦•à§à¦°à§Ÿ</div>
                    <div class="stock-detail-value">${p.totalPurchase.toFixed(2)} à§³</div>
                </div>
                <div class="stock-detail-item">
                    <div class="stock-detail-label">à¦®à§‹à¦Ÿ à¦²à¦¾à¦­</div>
                    <div class="stock-detail-value ${p.profit >= 0 ? 'positive' : 'negative'}">
                        ${p.profit >= 0 ? '+' : ''}${p.profit.toFixed(2)} à§³
                    </div>
                </div>
            </div>
            <div style="font-size:0.85rem; color:#718096; margin-bottom:10px;">
                ðŸ“… ${p.date} | ðŸ“ ${p.desc || 'à¦¬à¦¿à¦¬à¦°à¦£ à¦¨à§‡à¦‡'}
            </div>
            <div class="stock-actions">
                <button onclick="editProduct('${p.id}')" style="background:#f39c12; color:#fff;">à¦à¦¡à¦¿à¦Ÿ</button>
                <button onclick="deleteProduct('${p.id}')" style="background:#e74c3c; color:#fff;">à¦¡à¦¿à¦²à¦¿à¦Ÿ</button>
            </div>
        </div>
    `).join('');
}

function updateStockSummary() {
    updateTotalStockValue();
}

function updateTotalStockValue() {
    const totalPurchase = products.reduce((sum, p) => sum + p.totalPurchase, 0);
    
    // à¦¸à§à¦Ÿà¦• à¦¥à§‡à¦•à§‡ à¦¶à§à¦§à§ "à¦¦à¦¿à¦²à¦¾à¦®" (inc) à¦Ÿà¦¾à¦‡à¦ªà§‡à¦° à¦²à§‡à¦¨à¦¦à§‡à¦¨ à¦¬à¦¾à¦¦ à¦¦à§‡à§Ÿà¦¾ à¦¹à¦¬à§‡
    const totalGiven = transactions
        .filter(t => t.type === 'inc' && t.custName !== 'à¦•à§à¦¯à¦¾à¦¶à§‡ à¦¬à¦¿à¦•à§à¦°à§Ÿ')
        .reduce((sum, t) => sum + t.amount, 0);
    
    const currentStock = totalPurchase - totalGiven;
    document.getElementById('totalStockValue').textContent = currentStock.toFixed(2);
    
    if (currentStock < 0) {
        document.getElementById('totalStockValue').style.color = '#e74c3c';
    } else {
        document.getElementById('totalStockValue').style.color = '#2ecc71';
    }
}

function showAllStock() {
    stockDateFilter = { from: '', to: '' };
    stockSearchTerm = '';
    document.getElementById('productSearch').value = '';
    document.getElementById('stockFromDate').value = getBangladeshDateForInput();
    document.getElementById('stockToDate').value = getBangladeshDateForInput();
    updateProductList();
}

function updatePastPurchaseGrid() {
    const today = getBangladeshDate();
    const pastDays = [];
    
    for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        const dayProducts = products.filter(p => p.date === dateStr);
        const totalPurchase = dayProducts.reduce((sum, p) => sum + p.totalPurchase, 0);
        const dayName = ['à¦°à¦¬à¦¿', 'à¦¸à§‹à¦®', 'à¦®à¦™à§à¦—à¦²', 'à¦¬à§à¦§', 'à¦¬à§ƒà¦¹', 'à¦¶à§à¦•à§à¦°', 'à¦¶à¦¨à¦¿'][date.getDay()];
        
        pastDays.push({
            day: dayName,
            date: dateStr,
            amount: totalPurchase
        });
    }
    
    const grid = document.getElementById('pastPurchaseGrid');
    grid.innerHTML = pastDays.map(d => `
        <div class="past-cash-item">
            <div class="past-cash-day">${d.day}</div>
            <div class="past-cash-amount">${d.amount.toFixed(0)}</div>
        </div>
    `).join('');
}

function updatePurchaseAverages() {
    const today = getBangladeshDate();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth();
    
    const thisMonthData = products.filter(p => {
        const pDate = new Date(p.date + 'T00:00:00+06:00');
        return pDate.getFullYear() === currentYear && pDate.getMonth() === currentMonth;
    });
    
    const thisMonthTotal = thisMonthData.reduce((sum, p) => sum + p.totalPurchase, 0);
    
    document.getElementById('thisMonthPurchaseTotal').textContent = thisMonthTotal.toFixed(2);
    document.getElementById('thisMonthPurchaseDays').textContent = thisMonthData.length + ' à¦Ÿà¦¿ à¦•à§à¦°à§Ÿ';
    
    const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
    const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
    
    const lastMonthData = products.filter(p => {
        const pDate = new Date(p.date + 'T00:00:00+06:00');
        return pDate.getFullYear() === lastMonthYear && pDate.getMonth() === lastMonth;
    });
    
    const lastMonthTotal = lastMonthData.reduce((sum, p) => sum + p.totalPurchase, 0);
    
    document.getElementById('lastMonthPurchaseTotal').textContent = lastMonthTotal.toFixed(2);
    document.getElementById('lastMonthPurchaseDays').textContent = lastMonthData.length + ' à¦Ÿà¦¿ à¦•à§à¦°à§Ÿ';
}

function openNewExpenseModal() {
    editingExpenseId = null;
    document.getElementById('expenseModalTitle').textContent = 'à¦¨à¦¤à§à¦¨ à¦–à¦°à¦š';
    document.getElementById('saveExpenseBtn').innerHTML = '<span>âœ”</span> à¦–à¦°à¦š à¦¸à¦‚à¦°à¦•à§à¦·à¦£';
    document.getElementById('newExpenseModal').classList.add('show');
    document.getElementById('expenseDate').value = getBangladeshDateForInput();
    document.getElementById('expenseName').value = '';
    document.getElementById('expenseAmount').value = '';
    document.getElementById('expenseDesc').value = '';
}

function closeNewExpenseModal() {
    document.getElementById('newExpenseModal').classList.remove('show');
}

function saveExpense(e) {
    e.preventDefault();
    
    const date = document.getElementById('expenseDate').value;
    const name = document.getElementById('expenseName').value;
    const amount = parseFloat(document.getElementById('expenseAmount').value);
    const desc = document.getElementById('expenseDesc').value;
    
    const expense = {
        id: editingExpenseId || Date.now().toString(),
        date: date,
        name: name,
        amount: amount,
        desc: desc,
        timestamp: new Date(date + 'T00:00:00+06:00').getTime()
    };
    
    if (editingExpenseId) {
        const index = expenses.findIndex(e => e.id === editingExpenseId);
        if (index !== -1) expenses[index] = expense;
    } else {
        expenses.push(expense);
    }
    
    expenses.sort((a, b) => b.timestamp - a.timestamp);
    localStorage.setItem('expenses', JSON.stringify(expenses));
    
    closeNewExpenseModal();
    updateExpenseList();
    updateExpenseSummary();
    updatePastExpenseGrid();
    updateProfitLoss();
    
    pendingSync = true;
    if (isOnline && !isSyncing) {
        autoSync();
    }
}

function editExpense(id) {
    const expense = expenses.find(e => e.id === id);
    if (!expense) return;
    
    editingExpenseId = id;
    document.getElementById('expenseModalTitle').textContent = 'à¦–à¦°à¦š à¦¸à¦®à§à¦ªà¦¾à¦¦à¦¨à¦¾';
    document.getElementById('saveExpenseBtn').innerHTML = '<span>âœ”</span> à¦†à¦ªà¦¡à§‡à¦Ÿ';
    document.getElementById('expenseDate').value = expense.date;
    document.getElementById('expenseName').value = expense.name;
    document.getElementById('expenseAmount').value = expense.amount;
    document.getElementById('expenseDesc').value = expense.desc || '';
    
    document.getElementById('newExpenseModal').classList.add('show');
}

function deleteExpense(id) {
    if (!confirm('à¦à¦‡ à¦–à¦°à¦š à¦®à§à¦›à§‡ à¦«à§‡à¦²à¦¬à§‡à¦¨?')) return;
    
    expenses = expenses.filter(e => e.id !== id);
    localStorage.setItem('expenses', JSON.stringify(expenses));
    
    updateExpenseList();
    updateExpenseSummary();
    updatePastExpenseGrid();
    updateProfitLoss();
    
    pendingSync = true;
    if (isOnline && !isSyncing) {
        autoSync();
    }
}

function filterExpenses() {
    expenseSearchTerm = document.getElementById('expenseSearch').value.toLowerCase();
    updateExpenseList();
}

function applyExpenseDateFilter() {
    expenseDateFilter.from = document.getElementById('expenseFromDate').value;
    expenseDateFilter.to = document.getElementById('expenseToDate').value;
    updateExpenseList();
    updateExpenseSummary();
    updatePastExpenseGrid();
}

function resetExpenseDateFilter() {
    const today = getBangladeshDateForInput();
    document.getElementById('expenseFromDate').value = today;
    document.getElementById('expenseToDate').value = today;
    expenseDateFilter = { from: '', to: '' };
    updateExpenseList();
    updateExpenseSummary();
    updatePastExpenseGrid();
}

function updateExpenseList() {
    let filteredExpenses = expenses;
    
    if (expenseDateFilter.from && expenseDateFilter.to) {
        const fromDate = new Date(expenseDateFilter.from + 'T00:00:00+06:00');
        const toDate = new Date(expenseDateFilter.to + 'T23:59:59+06:00');
        
        filteredExpenses = filteredExpenses.filter(e => {
            const eDate = new Date(e.date + 'T00:00:00+06:00');
            return eDate >= fromDate && eDate <= toDate;
        });
    }
    
    if (expenseSearchTerm) {
        filteredExpenses = filteredExpenses.filter(e => 
            e.name.toLowerCase().includes(expenseSearchTerm) || 
            (e.desc && e.desc.toLowerCase().includes(expenseSearchTerm))
        );
    }
    
    const list = document.getElementById('expenseList');
    
    if (filteredExpenses.length === 0) {
        list.innerHTML = '<div class="info-msg">à¦•à§‹à¦¨ à¦–à¦°à¦š à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿</div>';
        return;
    }
    
    list.innerHTML = filteredExpenses.map(e => `
        <div class="expense-item">
            <div class="expense-header">
                <span class="expense-name">${e.name}</span>
                <span class="expense-amount">${e.amount.toFixed(2)} à§³</span>
            </div>
            ${e.desc ? `<div class="expense-desc">ðŸ“ ${e.desc}</div>` : ''}
            <div class="expense-meta">
                <span>ðŸ“… ${e.date}</span>
            </div>
            <div class="expense-actions">
                <button onclick="editExpense('${e.id}')" style="background:#f39c12; color:#fff;">à¦à¦¡à¦¿à¦Ÿ</button>
                <button onclick="deleteExpense('${e.id}')" style="background:#e74c3c; color:#fff;">à¦¡à¦¿à¦²à¦¿à¦Ÿ</button>
            </div>
        </div>
    `).join('');
}

function updateExpenseSummary() {
    const today = getBangladeshDate();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth();
    
    const thisMonthData = expenses.filter(e => {
        const eDate = new Date(e.date + 'T00:00:00+06:00');
        return eDate.getFullYear() === currentYear && eDate.getMonth() === currentMonth;
    });
    
    const thisMonthTotal = thisMonthData.reduce((sum, e) => sum + e.amount, 0);
    document.getElementById('thisMonthExpense').textContent = thisMonthTotal.toFixed(2);
    
    const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
    const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
    
    const lastMonthData = expenses.filter(e => {
        const eDate = new Date(e.date + 'T00:00:00+06:00');
        return eDate.getFullYear() === lastMonthYear && eDate.getMonth() === lastMonth;
    });
    
    const lastMonthTotal = lastMonthData.reduce((sum, e) => sum + e.amount, 0);
    document.getElementById('lastMonthExpense').textContent = lastMonthTotal.toFixed(2);
}

function updatePastExpenseGrid() {
    const today = getBangladeshDate();
    const pastDays = [];
    
    for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        const dayExpenses = expenses.filter(e => e.date === dateStr);
        const totalExpense = dayExpenses.reduce((sum, e) => sum + e.amount, 0);
        const dayName = ['à¦°à¦¬à¦¿', 'à¦¸à§‹à¦®', 'à¦®à¦™à§à¦—à¦²', 'à¦¬à§à¦§', 'à¦¬à§ƒà¦¹', 'à¦¶à§à¦•à§à¦°', 'à¦¶à¦¨à¦¿'][date.getDay()];
        
        pastDays.push({
            day: dayName,
            date: dateStr,
            amount: totalExpense
        });
    }
    
    const grid = document.getElementById('pastExpenseGrid');
    grid.innerHTML = pastDays.map(d => `
        <div class="past-cash-item">
            <div class="past-cash-day">${d.day}</div>
            <div class="past-cash-amount">${d.amount.toFixed(0)}</div>
        </div>
    `).join('');
}

function exportExpensesToExcel() {
    let filteredExpenses = expenses;
    
    if (expenseDateFilter.from && expenseDateFilter.to) {
        const fromDate = new Date(expenseDateFilter.from + 'T00:00:00+06:00');
        const toDate = new Date(expenseDateFilter.to + 'T23:59:59+06:00');
        
        filteredExpenses = filteredExpenses.filter(e => {
            const eDate = new Date(e.date + 'T00:00:00+06:00');
            return eDate >= fromDate && eDate <= toDate;
        });
    }
    
    if (expenseSearchTerm) {
        filteredExpenses = filteredExpenses.filter(e => 
            e.name.toLowerCase().includes(expenseSearchTerm) || 
            (e.desc && e.desc.toLowerCase().includes(expenseSearchTerm))
        );
    }
    
    const data = filteredExpenses.map(e => ({
        'à¦¤à¦¾à¦°à¦¿à¦–': e.date,
        'à¦–à¦°à¦šà§‡à¦° à¦¨à¦¾à¦®': e.name,
        'à¦ªà¦°à¦¿à¦®à¦¾à¦£': e.amount.toFixed(2),
        'à¦¬à¦¿à¦¬à¦°à¦£': e.desc || ''
    }));
    
    exportToCSV(data, 'à¦–à¦°à¦š');
}

function exportExpensesToTxt() {
    let filteredExpenses = expenses;
    
    if (expenseDateFilter.from && expenseDateFilter.to) {
        const fromDate = new Date(expenseDateFilter.from + 'T00:00:00+06:00');
        const toDate = new Date(expenseDateFilter.to + 'T23:59:59+06:00');
        
        filteredExpenses = filteredExpenses.filter(e => {
            const eDate = new Date(e.date + 'T00:00:00+06:00');
            return eDate >= fromDate && eDate <= toDate;
        });
    }
    
    if (expenseSearchTerm) {
        filteredExpenses = filteredExpenses.filter(e => 
            e.name.toLowerCase().includes(expenseSearchTerm) || 
            (e.desc && e.desc.toLowerCase().includes(expenseSearchTerm))
        );
    }
    
    let text = companyHeader;
    text += 'à¦–à¦°à¦š à¦¬à¦¿à¦¬à¦°à¦£\n';
    text += '==================\n\n';
    
    filteredExpenses.forEach(e => {
        text += `à¦¤à¦¾à¦°à¦¿à¦–: ${e.date}\n`;
        text += `à¦–à¦°à¦šà§‡à¦° à¦¨à¦¾à¦®: ${e.name}\n`;
        text += `à¦ªà¦°à¦¿à¦®à¦¾à¦£: ${e.amount.toFixed(2)} à§³\n`;
        if (e.desc) text += `à¦¬à¦¿à¦¬à¦°à¦£: ${e.desc}\n`;
        text += '------------------\n\n';
    });
    
    const total = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
    
    text += 'à¦¸à¦¾à¦°à¦¸à¦‚à¦•à§à¦·à§‡à¦ª\n';
    text += '==================\n';
    text += `à¦®à§‹à¦Ÿ à¦–à¦°à¦š: ${total.toFixed(2)} à§³\n`;
    text += `à¦®à§‹à¦Ÿ à¦à¦¨à§à¦Ÿà§à¦°à¦¿: ${filteredExpenses.length} à¦Ÿà¦¿\n`;
    
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `à¦–à¦°à¦š_${getBangladeshDateForInput()}.txt`;
    a.click();
}

// ==================== à¦†à¦ªà¦¡à§‡à¦Ÿà§‡à¦¡ à¦«à¦¾à¦‚à¦¶à¦¨ - à¦²à¦¾à¦­ à¦•à§à¦·à¦¤à¦¿ (à¦¶à§à¦§à§ à¦¬à¦°à§à¦¤à¦®à¦¾à¦¨ à¦…à¦¬à¦¸à§à¦¥à¦¾) ====================

function getCurrentAssets() {
    const today = getBangladeshDateForInput();
    const targetDate = new Date(today + 'T23:59:59+06:00');
    
    const cashOnDate = cashData
        .filter(c => {
            const cDate = new Date(c.date + 'T00:00:00+06:00');
            return cDate <= targetDate;
        })
        .sort((a, b) => b.timestamp - a.timestamp)[0];
    
    const cashAmount = cashOnDate ? cashOnDate.total : 0;
    
    let customerBalance = 0;
    
    customers.forEach(customer => {
        const customerTransactions = transactions
            .filter(t => t.custId === customer.id)
            .filter(t => {
                const tDate = new Date(t.fullDate);
                return tDate <= targetDate;
            });
        
        let given = 0;
        let taken = 0;
        
        customerTransactions.forEach(t => {
            if (t.type === 'inc') given += t.amount;
            else taken += t.amount;
        });
        
        customerBalance += (given - taken);
    });
    
    const totalPurchase = products.reduce((sum, p) => sum + p.totalPurchase, 0);
    const totalGiven = transactions
        .filter(t => t.type === 'inc' && t.custName !== 'à¦•à§à¦¯à¦¾à¦¶à§‡ à¦¬à¦¿à¦•à§à¦°à§Ÿ')
        .reduce((sum, t) => sum + t.amount, 0);
    
    const stockValue = totalPurchase - totalGiven;
    
    const thisMonthExpenses = expenses
        .filter(e => {
            const eDate = new Date(e.date + 'T00:00:00+06:00');
            const todayDate = getBangladeshDate();
            return eDate.getFullYear() === todayDate.getFullYear() && eDate.getMonth() === todayDate.getMonth();
        })
        .reduce((sum, e) => sum + e.amount, 0);
    
    return {
        cash: cashAmount,
        customer: customerBalance,
        stock: stockValue,
        total: cashAmount + customerBalance + stockValue,
        expenses: thisMonthExpenses
    };
}

function updateProfitLoss() {
    const assets = getCurrentAssets();
    
    const netResult = assets.total - (initialCapitalData.amount + assets.expenses);
    
    document.getElementById('calcTodayCash').textContent = assets.cash.toFixed(2);
    document.getElementById('calcCustomerBalance').textContent = assets.customer.toFixed(2);
    document.getElementById('calcStockValue').textContent = assets.stock.toFixed(2);
    document.getElementById('calcTotalAssets').textContent = assets.total.toFixed(2);
    document.getElementById('calcInitialCapital').textContent = (initialCapitalData.amount || 0).toFixed(2);
    document.getElementById('calcThisMonthExpense').textContent = assets.expenses.toFixed(2);
    
    const netEl = document.getElementById('calcNetResult');
    netEl.textContent = (netResult >= 0 ? '+' : '') + netResult.toFixed(2);
    netEl.style.color = netResult >= 0 ? '#2ecc71' : '#e74c3c';
    
    const profitEl = document.getElementById('profitLossAmount');
    profitEl.textContent = (netResult >= 0 ? '+' : '') + netResult.toFixed(2);
    profitEl.style.color = netResult >= 0 ? '#2ecc71' : '#e74c3c';
    
    const statusEl = document.getElementById('profitLossStatus');
    statusEl.textContent = netResult >= 0 ? '(à¦²à¦¾à¦­)' : '(à¦•à§à¦·à¦¤à¦¿)';
    statusEl.style.color = netResult >= 0 ? '#2ecc71' : '#e74c3c';
}

function applyProfitDateFilter() {
    profitDateFilter.from = document.getElementById('profitFromDate').value;
    profitDateFilter.to = document.getElementById('profitToDate').value;
    
    if (!profitDateFilter.from || !profitDateFilter.to) {
        alert('à¦¤à¦¾à¦°à¦¿à¦– à¦¸à¦¿à¦²à§‡à¦•à§à¦Ÿ à¦•à¦°à§à¦¨');
        return;
    }
    
    const targetDate = new Date(profitDateFilter.to + 'T23:59:59+06:00');
    
    const cashOnDate = cashData
        .filter(c => {
            const cDate = new Date(c.date + 'T00:00:00+06:00');
            return cDate <= targetDate;
        })
        .sort((a, b) => b.timestamp - a.timestamp)[0];
    
    const cashAmount = cashOnDate ? cashOnDate.total : 0;
    
    let customerBalance = 0;
    
    customers.forEach(customer => {
        const customerTransactions = transactions
            .filter(t => t.custId === customer.id)
            .filter(t => {
                const tDate = new Date(t.fullDate);
                return tDate <= targetDate;
            });
        
        let given = 0;
        let taken = 0;
        
        customerTransactions.forEach(t => {
            if (t.type === 'inc') given += t.amount;
            else taken += t.amount;
        });
        
        customerBalance += (given - taken);
    });
    
    const totalPurchase = products
        .filter(p => {
            const pDate = new Date(p.date + 'T00:00:00+06:00');
            return pDate <= targetDate;
        })
        .reduce((sum, p) => sum + p.totalPurchase, 0);
    
    const totalGiven = transactions
        .filter(t => t.type === 'inc' && t.custName !== 'à¦•à§à¦¯à¦¾à¦¶à§‡ à¦¬à¦¿à¦•à§à¦°à§Ÿ')
        .filter(t => {
            const tDate = new Date(t.fullDate);
            return tDate <= targetDate;
        })
        .reduce((sum, t) => sum + t.amount, 0);
    
    const stockValue = totalPurchase - totalGiven;
    
    const expensesAmount = expenses
        .filter(e => {
            const eDate = new Date(e.date + 'T00:00:00+06:00');
            const toDateObj = new Date(profitDateFilter.to + 'T23:59:59+06:00');
            return eDate <= toDateObj;
        })
        .reduce((sum, e) => sum + e.amount, 0);
    
    const totalAssets = cashAmount + customerBalance + stockValue;
    const netResult = totalAssets - (initialCapitalData.amount + expensesAmount);
    
    document.getElementById('filterCash').textContent = cashAmount.toFixed(2);
    document.getElementById('filterCustomer').textContent = customerBalance.toFixed(2);
    document.getElementById('filterStock').textContent = stockValue.toFixed(2);
    document.getElementById('filterTotalAssets').textContent = totalAssets.toFixed(2);
    document.getElementById('filterInitialCapital').textContent = initialCapitalData.amount.toFixed(2);
    document.getElementById('filterExpenses').textContent = expensesAmount.toFixed(2);
    
    const netEl = document.getElementById('filterNetResult');
    netEl.textContent = (netResult >= 0 ? '+' : '') + netResult.toFixed(2);
    netEl.style.color = netResult >= 0 ? '#2ecc71' : '#e74c3c';
}

function resetProfitDateFilter() {
    const today = getBangladeshDateForInput();
    document.getElementById('profitFromDate').value = today;
    document.getElementById('profitToDate').value = today;
    profitDateFilter = { from: '', to: '' };
    
    document.getElementById('filterCash').textContent = 'à§¦.à§¦à§¦';
    document.getElementById('filterCustomer').textContent = 'à§¦.à§¦à§¦';
    document.getElementById('filterStock').textContent = 'à§¦.à§¦à§¦';
    document.getElementById('filterTotalAssets').textContent = 'à§¦.à§¦à§¦';
    document.getElementById('filterInitialCapital').textContent = 'à§¦.à§¦à§¦';
    document.getElementById('filterExpenses').textContent = 'à§¦.à§¦à§¦';
    document.getElementById('filterNetResult').textContent = 'à§¦.à§¦à§¦';
    document.getElementById('filterNetResult').style.color = '#2d3748';
}

function exportProfitFilterToExcel() {
    if (!profitDateFilter.to) {
        alert('à¦ªà§à¦°à¦¥à¦®à§‡ à¦¤à¦¾à¦°à¦¿à¦– à¦«à¦¿à¦²à§à¦Ÿà¦¾à¦° à¦ªà§à¦°à¦¯à¦¼à§‹à¦— à¦•à¦°à§à¦¨');
        return;
    }
    
    const targetDate = new Date(profitDateFilter.to + 'T23:59:59+06:00');
    
    const cashOnDate = cashData
        .filter(c => {
            const cDate = new Date(c.date + 'T00:00:00+06:00');
            return cDate <= targetDate;
        })
        .sort((a, b) => b.timestamp - a.timestamp)[0];
    
    const cashAmount = cashOnDate ? cashOnDate.total : 0;
    
    let customerBalance = 0;
    
    customers.forEach(customer => {
        const customerTransactions = transactions
            .filter(t => t.custId === customer.id)
            .filter(t => {
                const tDate = new Date(t.fullDate);
                return tDate <= targetDate;
            });
        
        let given = 0;
        let taken = 0;
        
        customerTransactions.forEach(t => {
            if (t.type === 'inc') given += t.amount;
            else taken += t.amount;
        });
        
        customerBalance += (given - taken);
    });
    
    const totalPurchase = products
        .filter(p => {
            const pDate = new Date(p.date + 'T00:00:00+06:00');
            return pDate <= targetDate;
        })
        .reduce((sum, p) => sum + p.totalPurchase, 0);
    
    const totalGiven = transactions
        .filter(t => t.type === 'inc' && t.custName !== 'à¦•à§à¦¯à¦¾à¦¶à§‡ à¦¬à¦¿à¦•à§à¦°à§Ÿ')
        .filter(t => {
            const tDate = new Date(t.fullDate);
            return tDate <= targetDate;
        })
        .reduce((sum, t) => sum + t.amount, 0);
    
    const stockValue = totalPurchase - totalGiven;
    
    const expensesAmount = expenses
        .filter(e => {
            const eDate = new Date(e.date + 'T00:00:00+06:00');
            return eDate <= targetDate;
        })
        .reduce((sum, e) => sum + e.amount, 0);
    
    const totalAssets = cashAmount + customerBalance + stockValue;
    const netResult = totalAssets - (initialCapitalData.amount + expensesAmount);
    
    const data = [{
        'à¦¬à¦¿à¦¬à¦°à¦£': 'à¦ªà¦°à¦¿à¦®à¦¾à¦£',
        'à¦¤à¦¾à¦°à¦¿à¦–': profitDateFilter.to,
        'à¦®à§‹à¦Ÿ à¦•à§à¦¯à¦¾à¦¶': cashAmount.toFixed(2),
        'à¦—à§à¦°à¦¾à¦¹à¦• à¦¬à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¸': customerBalance.toFixed(2),
        'à¦¸à§à¦Ÿà¦• à¦®à§‚à¦²à§à¦¯': stockValue.toFixed(2),
        'à¦®à§‹à¦Ÿ à¦¸à¦®à§à¦ªà¦¦': totalAssets.toFixed(2),
        'à¦ªà§à¦°à¦¾à¦¥à¦®à¦¿à¦• à¦ªà§à¦à¦œà¦¿': initialCapitalData.amount.toFixed(2),
        'à¦®à§‹à¦Ÿ à¦–à¦°à¦š': expensesAmount.toFixed(2),
        'à¦¨à¦¿à¦Ÿ à¦«à¦²à¦¾à¦«à¦²': (netResult >= 0 ? '+' : '') + netResult.toFixed(2)
    }];
    
    exportToCSV(data, `à¦«à¦¿à¦²à§à¦Ÿà¦¾à¦°_à¦²à¦¾à¦­_à¦•à§à¦·à¦¤à¦¿_${profitDateFilter.to}`);
}

function exportProfitFilterToTxt() {
    if (!profitDateFilter.to) {
        alert('à¦ªà§à¦°à¦¥à¦®à§‡ à¦¤à¦¾à¦°à¦¿à¦– à¦«à¦¿à¦²à§à¦Ÿà¦¾à¦° à¦ªà§à¦°à¦¯à¦¼à§‹à¦— à¦•à¦°à§à¦¨');
        return;
    }
    
    const targetDate = new Date(profitDateFilter.to + 'T23:59:59+06:00');
    
    const cashOnDate = cashData
        .filter(c => {
            const cDate = new Date(c.date + 'T00:00:00+06:00');
            return cDate <= targetDate;
        })
        .sort((a, b) => b.timestamp - a.timestamp)[0];
    
    const cashAmount = cashOnDate ? cashOnDate.total : 0;
    
    let customerBalance = 0;
    
    customers.forEach(customer => {
        const customerTransactions = transactions
            .filter(t => t.custId === customer.id)
            .filter(t => {
                const tDate = new Date(t.fullDate);
                return tDate <= targetDate;
            });
        
        let given = 0;
        let taken = 0;
        
        customerTransactions.forEach(t => {
            if (t.type === 'inc') given += t.amount;
            else taken += t.amount;
        });
        
        customerBalance += (given - taken);
    });
    
    const totalPurchase = products
        .filter(p => {
            const pDate = new Date(p.date + 'T00:00:00+06:00');
            return pDate <= targetDate;
        })
        .reduce((sum, p) => sum + p.totalPurchase, 0);
    
    const totalGiven = transactions
        .filter(t => t.type === 'inc' && t.custName !== 'à¦•à§à¦¯à¦¾à¦¶à§‡ à¦¬à¦¿à¦•à§à¦°à§Ÿ')
        .filter(t => {
            const tDate = new Date(t.fullDate);
            return tDate <= targetDate;
        })
        .reduce((sum, t) => sum + t.amount, 0);
    
    const stockValue = totalPurchase - totalGiven;
    
    const expensesAmount = expenses
        .filter(e => {
            const eDate = new Date(e.date + 'T00:00:00+06:00');
            return eDate <= targetDate;
        })
        .reduce((sum, e) => sum + e.amount, 0);
    
    const totalAssets = cashAmount + customerBalance + stockValue;
    const netResult = totalAssets - (initialCapitalData.amount + expensesAmount);
    
    let text = companyHeader;
    text += `à¦«à¦¿à¦²à§à¦Ÿà¦¾à¦°à¦•à§ƒà¦¤ à¦²à¦¾à¦­ à¦•à§à¦·à¦¤à¦¿ à¦¬à¦¿à¦¬à¦°à¦£\n`;
    text += '===========================================\n\n';
    text += `à¦«à¦¿à¦²à§à¦Ÿà¦¾à¦° à¦¤à¦¾à¦°à¦¿à¦–: ${profitDateFilter.to}\n\n`;
    text += '------------------\n';
    text += `à¦®à§‹à¦Ÿ à¦•à§à¦¯à¦¾à¦¶: ${cashAmount.toFixed(2)} à§³\n`;
    text += `à¦—à§à¦°à¦¾à¦¹à¦• à¦¬à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¸: ${customerBalance.toFixed(2)} à§³\n`;
    text += `à¦¸à§à¦Ÿà¦• à¦®à§‚à¦²à§à¦¯: ${stockValue.toFixed(2)} à§³\n`;
    text += `à¦®à§‹à¦Ÿ à¦¸à¦®à§à¦ªà¦¦: ${totalAssets.toFixed(2)} à§³\n`;
    text += `à¦ªà§à¦°à¦¾à¦¥à¦®à¦¿à¦• à¦ªà§à¦à¦œà¦¿: ${initialCapitalData.amount.toFixed(2)} à§³\n`;
    text += `à¦®à§‹à¦Ÿ à¦–à¦°à¦š: ${expensesAmount.toFixed(2)} à§³\n`;
    text += `à¦¨à¦¿à¦Ÿ à¦«à¦²à¦¾à¦«à¦²: ${netResult >= 0 ? '+' : ''}${netResult.toFixed(2)} à§³\n`;
    text += '------------------\n\n';
    
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `à¦«à¦¿à¦²à§à¦Ÿà¦¾à¦°_à¦²à¦¾à¦­_à¦•à§à¦·à¦¤à¦¿_${profitDateFilter.to}.txt`;
    a.click();
}

function saveInitialCapital() {
    const date = document.getElementById('capitalDate').value;
    const amount = parseFloat(document.getElementById('initialCapital').value) || 0;
    
    initialCapitalData = {
        date: date,
        amount: amount
    };
    
    localStorage.setItem('initialCapital', JSON.stringify(initialCapitalData));
    alert('à¦ªà§à¦°à¦¾à¦¥à¦®à¦¿à¦• à¦ªà§à¦à¦œà¦¿ à¦¸à¦‚à¦°à¦•à§à¦·à¦£ à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡');
    updateProfitLoss();
    
    pendingSync = true;
    if (isOnline && !isSyncing) {
        autoSync();
    }
}

function loadInitialCapital() {
    document.getElementById('initialCapital').value = initialCapitalData.amount || 0;
    document.getElementById('capitalDate').value = initialCapitalData.date || getBangladeshDateForInput();
}

function saveNote() {
    const content = document.getElementById('noteContent').value.trim();
    if (!content) {
        alert('à¦¨à§‹à¦Ÿ à¦²à¦¿à¦–à§à¦¨');
        return;
    }
    
    const dateTime = getBangladeshDateTime();
    
    const note = {
        id: editingNoteId || Date.now().toString(),
        content: content,
        date: dateTime.date,
        time: dateTime.time,
        fullDateTime: dateTime.fullDateTime,
        timestamp: dateTime.timestamp
    };
    
    if (editingNoteId) {
        const index = notes.findIndex(n => n.id === editingNoteId);
        if (index !== -1) notes[index] = note;
        editingNoteId = null;
    } else {
        notes.push(note);
    }
    
    notes.sort((a, b) => b.timestamp - a.timestamp);
    localStorage.setItem('notes', JSON.stringify(notes));
    
    document.getElementById('noteContent').value = '';
    updateNotesList();
    
    pendingSync = true;
    if (isOnline && !isSyncing) {
        autoSync();
    }
}

function editNote(id) {
    const note = notes.find(n => n.id === id);
    if (!note) return;
    
    editingNoteId = id;
    document.getElementById('noteContent').value = note.content;
    document.getElementById('editNoteContent').value = note.content;
    document.getElementById('editNoteModal').classList.add('show');
}

function closeEditNoteModal() {
    document.getElementById('editNoteModal').classList.remove('show');
    editingNoteId = null;
    document.getElementById('editNoteContent').value = '';
}

function updateNote() {
    const content = document.getElementById('editNoteContent').value.trim();
    if (!content || !editingNoteId) return;
    
    const index = notes.findIndex(n => n.id === editingNoteId);
    if (index !== -1) {
        const dateTime = getBangladeshDateTime();
        notes[index].content = content;
        notes[index].date = dateTime.date;
        notes[index].time = dateTime.time;
        notes[index].fullDateTime = dateTime.fullDateTime;
        notes[index].timestamp = dateTime.timestamp;
        
        localStorage.setItem('notes', JSON.stringify(notes));
    }
    
    closeEditNoteModal();
    updateNotesList();
    
    pendingSync = true;
    if (isOnline && !isSyncing) {
        autoSync();
    }
}

function deleteNote(id) {
    if (!confirm('à¦à¦‡ à¦¨à§‹à¦Ÿ à¦®à§à¦›à§‡ à¦«à§‡à¦²à¦¬à§‡à¦¨?')) return;
    
    notes = notes.filter(n => n.id !== id);
    selectedNotes = selectedNotes.filter(n => n.id !== id);
    localStorage.setItem('notes', JSON.stringify(notes));
    localStorage.setItem('selectedNotes', JSON.stringify(selectedNotes));
    
    updateNotesList();
    updateSelectedNotesList();
    updateFloatingNotes();
    
    pendingSync = true;
    if (isOnline && !isSyncing) {
        autoSync();
    }
}

function copyNote(content) {
    navigator.clipboard.writeText(content).then(() => {
        alert('à¦¨à§‹à¦Ÿ à¦•à¦ªà¦¿ à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡');
    }).catch(() => {
        alert('à¦•à¦ªà¦¿ à¦•à¦°à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡');
    });
}

function filterNotes() {
    noteSearchTerm = document.getElementById('noteSearch').value.toLowerCase();
    updateNotesList();
}

function applyNoteDateFilter() {
    noteDateFilter.from = document.getElementById('noteFromDate').value;
    noteDateFilter.to = document.getElementById('noteToDate').value;
    updateNotesList();
}

function resetNoteDateFilter() {
    const today = getBangladeshDateForInput();
    document.getElementById('noteFromDate').value = today;
    document.getElementById('noteToDate').value = today;
    noteDateFilter = { from: '', to: '' };
    updateNotesList();
}

function getFilteredNotes() {
    let filtered = notes;
    
    if (noteDateFilter.from && noteDateFilter.to) {
        const fromDate = new Date(noteDateFilter.from + 'T00:00:00+06:00');
        const toDate = new Date(noteDateFilter.to + 'T23:59:59+06:00');
        
        filtered = filtered.filter(n => {
            const nDate = new Date(n.date + 'T00:00:00+06:00');
            return nDate >= fromDate && nDate <= toDate;
        });
    }
    
    if (noteSearchTerm) {
        filtered = filtered.filter(n => 
            n.content.toLowerCase().includes(noteSearchTerm)
        );
    }
    
    return filtered.sort((a, b) => b.timestamp - a.timestamp);
}

function updateNotesList() {
    const filtered = getFilteredNotes();
    const list = document.getElementById('notesList');
    
    if (filtered.length === 0) {
        list.innerHTML = '<div class="info-msg">à¦•à§‹à¦¨ à¦¨à§‹à¦Ÿ à¦¨à§‡à¦‡</div>';
        return;
    }
    
    list.innerHTML = filtered.map(note => {
        const isSelected = selectedNotes.some(sn => sn.id === note.id);
        return `
            <div class="note-item">
                <div class="note-header">
                    <span class="note-time">ðŸ“… ${note.date} â° ${note.time}</span>
                    ${isSelected ? '<span style="color:#f1c40f;">ðŸ“Œ à¦¸à¦¿à¦²à§‡à¦•à§à¦Ÿà§‡à¦¡</span>' : ''}
                </div>
                <div class="note-content">${note.content.replace(/\n/g, '<br>')}</div>
                <div class="note-actions">
                    <button class="note-select-btn" onclick="toggleSelectNote('${note.id}')">
                        ${isSelected ? 'ðŸ“Œ à¦¡à¦¿à¦¸à¦¿à¦²à§‡à¦•à§à¦Ÿ' : 'ðŸ“Œ à¦¸à¦¿à¦²à§‡à¦•à§à¦Ÿ'}
                    </button>
                    <button class="note-copy-btn" onclick="copyNote('${note.content.replace(/'/g, "\\'")}')">ðŸ“‹ à¦•à¦ªà¦¿</button>
                    <button class="note-edit-btn" onclick="editNote('${note.id}')">âœ à¦à¦¡à¦¿à¦Ÿ</button>
                    <button class="note-delete-btn" onclick="deleteNote('${note.id}')">ðŸ—‘ à¦¡à¦¿à¦²à¦¿à¦Ÿ</button>
                </div>
            </div>
        `;
    }).join('');
}

function exportNotesToTxt() {
    const filtered = getFilteredNotes();
    
    let text = companyHeader;
    text += 'à¦¨à§‹à¦Ÿ à¦¬à¦¿à¦¬à¦°à¦£\n';
    text += '==================\n\n';
    
    filtered.forEach(note => {
        text += `à¦¤à¦¾à¦°à¦¿à¦–: ${note.date} ${note.time}\n`;
        text += `à¦¨à§‹à¦Ÿ:\n${note.content}\n`;
        text += '------------------\n\n';
    });
    
    text += 'à¦¸à¦¾à¦°à¦¸à¦‚à¦•à§à¦·à§‡à¦ª\n';
    text += '==================\n';
    text += `à¦®à§‹à¦Ÿ à¦¨à§‹à¦Ÿ: ${filtered.length} à¦Ÿà¦¿\n`;
    text += `à¦¸à¦¿à¦²à§‡à¦•à§à¦Ÿà§‡à¦¡ à¦¨à§‹à¦Ÿ: ${selectedNotes.length} à¦Ÿà¦¿\n`;
    
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `à¦¨à§‹à¦Ÿ_${getBangladeshDateForInput()}.txt`;
    a.click();
}

function exportToExcel() {
    const data = customers.map(customer => {
        const stats = calculateCustomerStats(customer.id, currentDateFilter);
        return {
            'à¦¨à¦¾à¦®': customer.name,
            'à¦«à§‹à¦¨': customer.phone || '',
            'à¦ à¦¿à¦•à¦¾à¦¨à¦¾': customer.addr || '',
            'à¦®à§‹à¦Ÿ à¦¦à¦¿à¦²à¦¾à¦®': stats.totalGiven.toFixed(2),
            'à¦®à§‹à¦Ÿ à¦ªà§‡à¦²à¦¾à¦®': stats.totalTaken.toFixed(2),
            'à¦¬à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¸': (stats.balance >= 0 ? '+' : '') + stats.balance.toFixed(2),
            'à¦²à§‡à¦¨à¦¦à§‡à¦¨ à¦¸à¦‚à¦–à§à¦¯à¦¾': stats.transactionCount
        };
    });
    
    exportToCSV(data, 'à¦—à§à¦°à¦¾à¦¹à¦•_à¦¸à¦¾à¦°à¦¾à¦‚à¦¶');
}

function exportToTxt() {
    let text = companyHeader;
    text += 'à¦—à§à¦°à¦¾à¦¹à¦• à¦¸à¦¾à¦°à¦¾à¦‚à¦¶\n';
    text += '==================\n\n';
    
    customers.forEach(customer => {
        const stats = calculateCustomerStats(customer.id, currentDateFilter);
        text += `à¦¨à¦¾à¦®: ${customer.name}\n`;
        text += `à¦«à§‹à¦¨: ${customer.phone || 'à¦¨à§‡à¦‡'}\n`;
        text += `à¦ à¦¿à¦•à¦¾à¦¨à¦¾: ${customer.addr || 'à¦¨à§‡à¦‡'}\n`;
        text += `à¦®à§‹à¦Ÿ à¦¦à¦¿à¦²à¦¾à¦®: +${stats.totalGiven.toFixed(2)}\n`;
        text += `à¦®à§‹à¦Ÿ à¦ªà§‡à¦²à¦¾à¦®: -${stats.totalTaken.toFixed(2)}\n`;
        text += `à¦¬à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¸: ${stats.balance >= 0 ? '+' : ''}${stats.balance.toFixed(2)}\n`;
        text += `à¦²à§‡à¦¨à¦¦à§‡à¦¨: ${stats.transactionCount} à¦Ÿà¦¿\n`;
        text += '------------------\n\n';
    });
    
    const totalGiven = customers.reduce((sum, c) => sum + calculateCustomerStats(c.id, currentDateFilter).totalGiven, 0);
    const totalTaken = customers.reduce((sum, c) => sum + calculateCustomerStats(c.id, currentDateFilter).totalTaken, 0);
    const totalBalance = totalGiven - totalTaken;
    
    text += 'à¦¸à¦°à§à¦¬à¦®à§‹à¦Ÿ\n';
    text += '==================\n';
    text += `à¦®à§‹à¦Ÿ à¦—à§à¦°à¦¾à¦¹à¦•: ${customers.length}\n`;
    text += `à¦¸à¦°à§à¦¬à¦®à§‹à¦Ÿ à¦¦à¦¿à¦²à¦¾à¦®: +${totalGiven.toFixed(2)}\n`;
    text += `à¦¸à¦°à§à¦¬à¦®à§‹à¦Ÿ à¦ªà§‡à¦²à¦¾à¦®: -${totalTaken.toFixed(2)}\n`;
    text += `à¦¸à¦°à§à¦¬à¦®à§‹à¦Ÿ à¦¬à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¸: ${totalBalance >= 0 ? '+' : ''}${totalBalance.toFixed(2)}\n`;
    
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `à¦—à§à¦°à¦¾à¦¹à¦•_à¦¸à¦¾à¦°à¦¾à¦‚à¦¶_${getBangladeshDateForInput()}.txt`;
    a.click();
}

function exportCustomerToExcel(customerId) {
    const customer = customers.find(c => c.id === customerId);
    if (!customer) return;
    
    const fromDate = document.getElementById('modalFromDate')?.value;
    const toDate = document.getElementById('modalToDate')?.value;
    
    let customerTransactions = transactions.filter(t => t.custId === customerId);
    
    if (fromDate && toDate) {
        const from = new Date(fromDate + 'T00:00:00+06:00');
        const to = new Date(toDate + 'T23:59:59+06:00');
        
        customerTransactions = customerTransactions.filter(t => {
            const tDate = new Date(t.fullDate);
            return tDate >= from && tDate <= to;
        });
    }
    
    customerTransactions.sort((a, b) => a.timestamp - b.timestamp);
    
    let balance = 0;
    const data = customerTransactions.map(t => {
        balance += t.type === 'inc' ? t.amount : -t.amount;
        return {
            'à¦¤à¦¾à¦°à¦¿à¦–': t.date,
            'à¦¸à¦®à¦¯à¦¼': t.time,
            'à¦Ÿà¦¾à¦‡à¦ª': t.type === 'inc' ? 'à¦¦à¦¿à¦²à¦¾à¦®' : 'à¦ªà§‡à¦²à¦¾à¦®',
            'à¦¬à¦¿à¦¬à¦°à¦£': t.desc,
            'à¦ªà¦°à¦¿à¦®à¦¾à¦£': (t.type === 'inc' ? '+' : '-') + t.amount.toFixed(2),
            'à¦°à¦¾à¦¨à¦¿à¦‚ à¦¬à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¸': (balance >= 0 ? '+' : '') + balance.toFixed(2)
        };
    });
    
    exportToCSV(data, `${customer.name}_à¦²à§‡à¦¨à¦¦à§‡à¦¨`);
}

function exportCustomerToTxt(customerId) {
    const customer = customers.find(c => c.id === customerId);
    if (!customer) return;
    
    const fromDate = document.getElementById('modalFromDate')?.value;
    const toDate = document.getElementById('modalToDate')?.value;
    
    let customerTransactions = transactions.filter(t => t.custId === customerId);
    
    if (fromDate && toDate) {
        const from = new Date(fromDate + 'T00:00:00+06:00');
        const to = new Date(toDate + 'T23:59:59+06:00');
        
        customerTransactions = customerTransactions.filter(t => {
            const tDate = new Date(t.fullDate);
            return tDate >= from && tDate <= to;
        });
    }
    
    customerTransactions.sort((a, b) => a.timestamp - b.timestamp);
    
    const stats = calculateCustomerStats(customerId, fromDate && toDate ? { from: fromDate, to: toDate } : null);
    
    let text = companyHeader;
    text += `${customer.name} - à¦²à§‡à¦¨à¦¦à§‡à¦¨ à¦¬à¦¿à¦¬à¦°à¦£\n`;
    text += '==================\n\n';
    text += `à¦«à§‹à¦¨: ${customer.phone || 'à¦¨à§‡à¦‡'}\n`;
    text += `à¦ à¦¿à¦•à¦¾à¦¨à¦¾: ${customer.addr || 'à¦¨à§‡à¦‡'}\n\n`;
    text += `à¦®à§‹à¦Ÿ à¦¦à¦¿à¦²à¦¾à¦®: +${stats.totalGiven.toFixed(2)}\n`;
    text += `à¦®à§‹à¦Ÿ à¦ªà§‡à¦²à¦¾à¦®: -${stats.totalTaken.toFixed(2)}\n`;
    text += `à¦¬à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¸: ${stats.balance >= 0 ? '+' : ''}${stats.balance.toFixed(2)}\n`;
    text += '==================\n\n';
    text += 'à¦²à§‡à¦¨à¦¦à§‡à¦¨à¦¸à¦®à§‚à¦¹:\n';
    text += '------------------\n';
    
    let balance = 0;
    customerTransactions.forEach(t => {
        balance += t.type === 'inc' ? t.amount : -t.amount;
        text += `\nà¦¤à¦¾à¦°à¦¿à¦–: ${t.date} ${t.time}\n`;
        text += `à¦Ÿà¦¾à¦‡à¦ª: ${t.type === 'inc' ? 'à¦¦à¦¿à¦²à¦¾à¦®' : 'à¦ªà§‡à¦²à¦¾à¦®'}\n`;
        text += `à¦¬à¦¿à¦¬à¦°à¦£: ${t.desc}\n`;
        text += `à¦ªà¦°à¦¿à¦®à¦¾à¦£: ${t.type === 'inc' ? '+' : '-'}${t.amount.toFixed(2)}\n`;
        text += `à¦¬à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¸: ${balance >= 0 ? '+' : ''}${balance.toFixed(2)}\n`;
    });
    
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${customer.name}_à¦²à§‡à¦¨à¦¦à§‡à¦¨_${getBangladeshDateForInput()}.txt`;
    a.click();
}

function exportStockToExcel() {
    let filteredProducts = products;
    
    if (stockDateFilter.from && stockDateFilter.to) {
        const fromDate = new Date(stockDateFilter.from + 'T00:00:00+06:00');
        const toDate = new Date(stockDateFilter.to + 'T23:59:59+06:00');
        
        filteredProducts = filteredProducts.filter(p => {
            const pDate = new Date(p.date + 'T00:00:00+06:00');
            return pDate >= fromDate && pDate <= toDate;
        });
    }
    
    if (stockSearchTerm) {
        filteredProducts = filteredProducts.filter(p => 
            p.name.toLowerCase().includes(stockSearchTerm)
        );
    }
    
    const data = filteredProducts.map(p => ({
        'à¦¤à¦¾à¦°à¦¿à¦–': p.date,
        'à¦ªà¦£à§à¦¯à§‡à¦° à¦¨à¦¾à¦®': p.name,
        'à¦ªà¦°à¦¿à¦®à¦¾à¦£': p.qty,
        'à¦à¦•à¦•': p.unit,
        'à¦¬à¦¿à¦¬à¦°à¦£': p.desc || '',
        'à¦•à§à¦°à§Ÿ à¦®à§‚à¦²à§à¦¯ (à¦ªà§à¦°à¦¤à¦¿)': p.purchasePrice,
        'à¦¬à¦¿à¦•à§à¦°à§Ÿ à¦®à§‚à¦²à§à¦¯ (à¦ªà§à¦°à¦¤à¦¿)': p.sellPrice,
        'à¦®à§‹à¦Ÿ à¦•à§à¦°à§Ÿ': p.totalPurchase.toFixed(2),
        'à¦®à§‹à¦Ÿ à¦¬à¦¿à¦•à§à¦°à§Ÿ': p.totalSell.toFixed(2),
        'à¦®à§‹à¦Ÿ à¦²à¦¾à¦­': p.profit.toFixed(2)
    }));
    
    exportToCSV(data, 'à¦•à§à¦°à§Ÿ_à¦“_à¦¸à§à¦Ÿà¦•');
}

function exportStockToTxt() {
    let filteredProducts = products;
    
    if (stockDateFilter.from && stockDateFilter.to) {
        const fromDate = new Date(stockDateFilter.from + 'T00:00:00+06:00');
        const toDate = new Date(stockDateFilter.to + 'T23:59:59+06:00');
        
        filteredProducts = filteredProducts.filter(p => {
            const pDate = new Date(p.date + 'T00:00:00+06:00');
            return pDate >= fromDate && pDate <= toDate;
        });
    }
    
    if (stockSearchTerm) {
        filteredProducts = filteredProducts.filter(p => 
            p.name.toLowerCase().includes(stockSearchTerm)
        );
    }
    
    let text = companyHeader;
    text += 'à¦•à§à¦°à§Ÿ à¦“ à¦¸à§à¦Ÿà¦• à¦¬à¦¿à¦¬à¦°à¦£\n';
    text += '==================\n\n';
    
    filteredProducts.forEach(p => {
        text += `à¦¤à¦¾à¦°à¦¿à¦–: ${p.date}\n`;
        text += `à¦ªà¦£à§à¦¯: ${p.name}\n`;
        text += `à¦ªà¦°à¦¿à¦®à¦¾à¦£: ${p.qty} ${p.unit}\n`;
        text += `à¦¬à¦¿à¦¬à¦°à¦£: ${p.desc || 'à¦¨à§‡à¦‡'}\n`;
        text += `à¦•à§à¦°à§Ÿ à¦®à§‚à¦²à§à¦¯: ${p.purchasePrice} à§³\n`;
        text += `à¦¬à¦¿à¦•à§à¦°à§Ÿ à¦®à§‚à¦²à§à¦¯: ${p.sellPrice} à§³\n`;
        text += `à¦®à§‹à¦Ÿ à¦•à§à¦°à§Ÿ: ${p.totalPurchase.toFixed(2)} à§³\n`;
        text += `à¦®à§‹à¦Ÿ à¦¬à¦¿à¦•à§à¦°à§Ÿ: ${p.totalSell.toFixed(2)} à§³\n`;
        text += `à¦®à§‹à¦Ÿ à¦²à¦¾à¦­: ${p.profit.toFixed(2)} à§³\n`;
        text += '------------------\n\n';
    });
    
    const totalPurchase = filteredProducts.reduce((sum, p) => sum + p.totalPurchase, 0);
    const totalProfit = filteredProducts.reduce((sum, p) => sum + p.profit, 0);
    
    text += 'à¦¸à¦¾à¦°à¦¸à¦‚à¦•à§à¦·à§‡à¦ª\n';
    text += '==================\n';
    text += `à¦®à§‹à¦Ÿ à¦•à§à¦°à§Ÿ: ${totalPurchase.toFixed(2)} à§³\n`;
    text += `à¦®à§‹à¦Ÿ à¦²à¦¾à¦­: ${totalProfit.toFixed(2)} à§³\n`;
    text += `à¦®à§‹à¦Ÿ à¦ªà¦£à§à¦¯: ${filteredProducts.length} à¦Ÿà¦¿\n`;
    
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `à¦•à§à¦°à§Ÿ_à¦“_à¦¸à§à¦Ÿà¦•_${getBangladeshDateForInput()}.txt`;
    a.click();
}

function exportToCSV(data, filename) {
    const headers = Object.keys(data[0]);
    const csv = [
        headers.join(','),
        ...data.map(r => headers.map(h => `"${r[h]}"`).join(','))
    ].join('\n');
    
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${filename}_${getBangladeshDateForInput()}.csv`;
    a.click();
}

function closeDetailModal() {
    document.getElementById('customerDetailModal').classList.remove('show');
}

document.addEventListener('click', function(e) {
    if (!e.target.closest('.customer-section')) {
        document.getElementById('custList').classList.remove('show');
    }
    if (!e.target.closest('#productName') && !e.target.closest('#productNameList')) {
        document.getElementById('productNameList').style.display = 'none';
    }
});

window.switchTab = switchTab;
window.setType = setType;
window.showList = showList;
window.filterCust = filterCust;
window.selectCustomer = selectCustomer;
window.openNewCustomerModal = openNewCustomerModal;
window.closeNewCustomerModal = closeNewCustomerModal;
window.saveNewCustomer = saveNewCustomer;
window.saveTransaction = saveTransaction;
window.editTransaction = editTransaction;
window.deleteTransaction = deleteTransaction;
window.filterTransactionByType = filterTransactionByType;
window.applyTransactionDateFilter = applyTransactionDateFilter;
window.resetTransactionDateFilter = resetTransactionDateFilter;
window.filterTransactions = filterTransactions;
window.exportTransactionsToExcel = exportTransactionsToExcel;
window.exportTransactionsToTxt = exportTransactionsToTxt;
window.filterCustomers = filterCustomers;
window.filterByBalance = filterByBalance;
window.applyDateFilter = applyDateFilter;
window.resetDateFilter = resetDateFilter;
window.showCustomerDetail = showCustomerDetail;
window.applyModalDateFilter = applyModalDateFilter;
window.resetModalDateFilter = resetModalDateFilter;
window.exportToExcel = exportToExcel;
window.exportToTxt = exportToTxt;
window.exportCustomerToExcel = exportCustomerToExcel;
window.exportCustomerToTxt = exportCustomerToTxt;
window.editCustomer = editCustomer;
window.deleteCustomer = deleteCustomer;
window.calculateCashTotal = calculateCashTotal;
window.saveCashData = saveCashData;
window.applyCashDateFilter = applyCashDateFilter;
window.resetCashDateFilter = resetCashDateFilter;
window.exportCashToExcel = exportCashToExcel;
window.exportCashToTxt = exportCashToTxt;
window.openNewProductModal = openNewProductModal;
window.closeNewProductModal = closeNewProductModal;
window.searchProductName = searchProductName;
window.selectProductName = selectProductName;
window.showProductDropdown = showProductDropdown;
window.calculateProfit = calculateProfit;
window.saveProduct = saveProduct;
window.editProduct = editProduct;
window.deleteProduct = deleteProduct;
window.filterProducts = filterProducts;
window.applyStockDateFilter = applyStockDateFilter;
window.resetStockDateFilter = resetStockDateFilter;
window.showAllStock = showAllStock;
window.exportStockToExcel = exportStockToExcel;
window.exportStockToTxt = exportStockToTxt;
window.openNewExpenseModal = openNewExpenseModal;
window.closeNewExpenseModal = closeNewExpenseModal;
window.saveExpense = saveExpense;
window.editExpense = editExpense;
window.deleteExpense = deleteExpense;
window.filterExpenses = filterExpenses;
window.applyExpenseDateFilter = applyExpenseDateFilter;
window.resetExpenseDateFilter = resetExpenseDateFilter;
window.exportExpensesToExcel = exportExpensesToExcel;
window.exportExpensesToTxt = exportExpensesToTxt;
window.saveInitialCapital = saveInitialCapital;
window.applyProfitDateFilter = applyProfitDateFilter;
window.resetProfitDateFilter = resetProfitDateFilter;
window.exportProfitFilterToExcel = exportProfitFilterToExcel;
window.exportProfitFilterToTxt = exportProfitFilterToTxt;
window.saveNote = saveNote;
window.editNote = editNote;
window.closeEditNoteModal = closeEditNoteModal;
window.updateNote = updateNote;
window.deleteNote = deleteNote;
window.copyNote = copyNote;
window.filterNotes = filterNotes;
window.applyNoteDateFilter = applyNoteDateFilter;
window.resetNoteDateFilter = resetNoteDateFilter;
window.toggleSelectNote = toggleSelectNote;
window.removeSelectedNote = removeSelectedNote;
window.exportNotesToTxt = exportNotesToTxt;
window.closeDetailModal = closeDetailModal;

loadFromFirebase();
updateSyncStatus();
init();
</script>

<script>
function mergeArrays(localArr, serverArr){
    let map = {};
    serverArr.forEach(i=>map[i.id]=i);
    localArr.forEach(i=>{
        if(!map[i.id] || (i.timestamp||0) > (map[i.id].timestamp||0)){
            map[i.id]=i;
        }
    });
    return Object.values(map);
}

function mergeLocalWithServer(key, serverData){
    let local = JSON.parse(localStorage.getItem(key)) || [];
    let merged = mergeArrays(local, serverData);
    localStorage.setItem(key, JSON.stringify(merged));
}
</script>

<script type="module">
import { onSnapshot, collection } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

function listenRealtime(){
    const collections = ['transactions','customers','cashData','products','expenses','notes'];

    collections.forEach(name=>{
        const ref = collection(db, name);
        onSnapshot(ref, (snapshot)=>{
            let serverData = [];
            snapshot.forEach(doc=>{
                serverData.push(doc.data());
            });
            mergeLocalWithServer(name, serverData);
            updateDashboard();
        });
    });
}

listenRealtime();
</script>


<script>
// AUTO PUSH TO FIREBASE
function autoPush(){
    if(typeof syncAllToFirebase === 'function'){
        syncAllToFirebase();
    }
}
setInterval(autoPush, 2000);
</script>

</body>
</html>


